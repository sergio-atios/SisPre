<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisPre Pro - Sistema de Precifica√ß√£o Profissional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 2rem; 
            margin-bottom: 1.5rem; 
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 0 12px 40px rgba(31, 38, 135, 0.4);
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            border: none;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn-blue { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        .btn-green { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
        }
        .btn-red { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.6);
        }
        .btn-gray { 
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568; 
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
        }
        .btn-gray:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #cbd5e0;
        }
        .input { 
            width: 100%; 
            padding: 0.875rem 1rem; 
            border: 2px solid rgba(226, 232, 240, 0.8); 
            border-radius: 12px; 
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .input:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        .hidden { display: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; }
        .space-y > * + * { margin-top: 1.5rem; }
        .text-green { color: #38a169; }
        .text-red { color: #e53e3e; }
        .text-gray { color: #718096; }
        .bg-green-light { 
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            border: 1px solid rgba(72, 187, 120, 0.2); 
            padding: 1.5rem; 
            border-radius: 16px; 
        }
        .bg-blue-light { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2); 
            padding: 1.5rem; 
            border-radius: 16px; 
        }
        .bg-yellow-light { 
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 1px solid rgba(251, 191, 36, 0.2); 
            padding: 1.5rem; 
            border-radius: 16px; 
        }
        .status-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            display: inline-block; 
            animation: pulse 2s infinite;
            box-shadow: 0 0 20px rgba(72, 187, 120, 0.6);
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: .7; transform: scale(1.1); } 
        }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 0.75rem; }
        .gap-4 { gap: 1.5rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 600; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .p-4 { padding: 1.5rem; }
        .rounded { border-radius: 12px; }
        .border { border: 1px solid rgba(226, 232, 240, 0.8); }
        .item-card {
            background: rgba(249, 250, 251, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: 16px;
            border: 1px solid rgba(229, 231, 235, 0.6);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .item-card:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .input-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        .input-small {
            padding: 0.5rem 0.75rem;
            border: 2px solid rgba(209, 213, 219, 0.8);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        .input-small:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; gap: 1rem; }
            .container { padding: 1rem; }
            .card { padding: 1.5rem; }
        }
        
        /* Estilos espec√≠ficos para upload */
        #areaUpload {
            transition: all 0.4s ease;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(102, 126, 234, 0.3);
        }
        #areaUpload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-2px);
        }
        #areaUpload.drag-over {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
            box-shadow: 0 0 30px rgba(72, 187, 120, 0.3);
        }
        
        /* Melhorias nos indicadores */
        .w-4 {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .bg-gray-300 { background: #d1d5db; }
        .bg-blue-500 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: pulse 1s infinite;
        }
        .bg-green-500 { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 0 15px rgba(72, 187, 120, 0.5);
        }
        .bg-red-500 { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 0 15px rgba(245, 101, 101, 0.5);
        }
        .bg-yellow-500 { 
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
            box-shadow: 0 0 15px rgba(236, 201, 75, 0.5);
        }
        .bg-yellow-300 { 
            background: linear-gradient(135deg, #faf089 0%, #f6e05e 100%);
        }
        
        /* Header modernizado */
        h1 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -0.025em;
        }
        
        /* Se√ß√µes de resultado mais modernas */
        #resultado {
            border-radius: 16px;
            overflow: hidden;
        }

        /* Alerta de corre√ß√£o */
        .alerta-correcao {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            animation: destacar 3s ease-in-out;
        }
        
        @keyframes destacar {
            0%, 100% { 
                border-color: rgba(34, 197, 94, 0.3);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }
            50% { 
                border-color: rgba(34, 197, 94, 0.8);
                box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.2);
            }
        }

        /* ========== ESTILOS DA AN√ÅLISE REVERSA ========== */
        .cenario-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 2px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        .cenario-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .cenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        .input-nome-cenario {
            font-size: 1.25rem;
            font-weight: 700;
            border: none;
            background: transparent;
            color: #2d3748;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            flex: 1;
            margin-right: 1rem;
        }
        .input-nome-cenario:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        .input-nome-cenario:focus {
            outline: none;
            background: rgba(102, 126, 234, 0.1);
        }
        .cenario-acoes {
            display: flex;
            gap: 0.5rem;
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .cenario-form {
            display: grid;
            gap: 1rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-size: 0.875rem;
        }
        .cenario-resultado {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }
        .alerta-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .resultado-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .resultado-item {
            text-align: center;
            padding: 1rem;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .resultado-label {
            font-size: 0.75rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .resultado-valor {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2d3748;
        }
        
        /* Tabela de compara√ß√£o */
        .tabela-comparacao {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        .tabela-comparacao thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tabela-comparacao th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tabela-comparacao td {
            padding: 1rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            background: white;
        }
        .tabela-comparacao tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        .tabela-comparacao tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .resultado-resumo {
                grid-template-columns: 1fr;
            }
            .cenario-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .input-nome-cenario {
                width: 100%;
                margin-right: 0;
            }
            .tabela-comparacao {
                font-size: 0.875rem;
            }
            .tabela-comparacao th,
            .tabela-comparacao td {
                padding: 0.75rem 0.5rem;
            }
        }

    </style>

<style>
/* CSS Mobile Responsivo */
@media (max-width: 768px) {
    header {
        padding: 12px 10px !important;
    }
    
    header h1 {
        font-size: 1.2rem !important;
        margin-bottom: 12px !important;
    }
    
    .header-buttons {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
        width: 100% !important;
    }
    
    .header-buttons .btn {
        width: 100% !important;
        font-size: 0.85rem !important;
        padding: 10px 6px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
}

@media (max-width: 480px) {
    .header-buttons {
        grid-template-columns: 1fr !important;
    }
}
</style>





<style id="css-mobile-e-desktop-correto">
/* ========================================================================
   CSS MOBILE E DESKTOP - SELETORES CORRETOS
   ======================================================================== */

/* DESKTOP - Checkboxes mais pr√≥ximos */
/* DESKTOP - Layout dos checkboxes pr√≥ximos */
#telaAnalise .grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 15px;
}

/* Linha 1: Pre√ßo, Custo, Frete (span 2) */
#telaAnalise .grid-3 > div:nth-child(1),
#telaAnalise .grid-3 > div:nth-child(2) {
    grid-column: span 1;
}

#telaAnalise .grid-3 > div:nth-child(3) {
    grid-column: span 2;
}

/* Linha 2: Empresa (span 2), Marketplace (span 2) */
#telaAnalise .grid-3 > div:nth-child(4),
#telaAnalise .grid-3 > div:nth-child(5) {
    grid-column: span 2;
}

/* Linha 3: Checkboxes lado a lado - PR√ìXIMOS! */
#telaAnalise .grid-3 > div:nth-child(6) {
    grid-column: 1 / 2;
}

#telaAnalise .grid-3 > div:nth-child(7) {
    grid-column: 2 / 3;
}

/* Mobile: voltar para 1 coluna */
@media (max-width: 768px) {
    #telaAnalise .grid-3 {
        grid-template-columns: 1fr !important;
    }
    
    #telaAnalise .grid-3 > div {
        grid-column: span 1 !important;
    }
}

/* MOBILE - Tablets */
@media (max-width: 768px) {
    /* Header */
    .card > .flex.justify-between {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 15px !important;
    }
    
    /* Container dos bot√µes - o div com classe "flex gap-2" */
    .card > .flex.justify-between > .flex.gap-2 {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
        width: 100% !important;
    }
    
    /* Bot√µes individuais */
    .card > .flex.justify-between > .flex.gap-2 > button {
        width: 100% !important;
        font-size: 0.8rem !important;
        padding: 10px 6px !important;
        white-space: nowrap !important;
        margin: 0 !important;
    }
    
    /* T√≠tulo menor no mobile */
    .card h1 {
        font-size: 1.5rem !important;
    }
    
    .card p {
        font-size: 0.9rem !important;
    }
}

/* MOBILE - Smartphones pequenos */
@media (max-width: 480px) {
    /* Bot√µes em 1 coluna */
    .card > .flex.justify-between > .flex.gap-2 {
        grid-template-columns: 1fr !important;
    }
    
    /* Bot√µes maiores para facilitar clique */
    .card > .flex.justify-between > .flex.gap-2 > button {
        font-size: 0.9rem !important;
        padding: 12px !important;
    }
}
</style>

</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">üìä</div>
                    <div>
                        <h1 style="font-size: 2.5rem; font-weight: 800; margin: 0;">SisPre</h1>
                        <p style="color: #718096; margin: 0; font-size: 1.1rem; font-weight: 500;">Sistema de Precifica√ß√£o</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btnCalculo" onclick="mostrarTela('calculo')" class="btn btn-blue">üí∞ Calcular</button>
            <button id="btnLote" onclick="mostrarTela('lote')" class="btn btn-gray">üì¶ Lote</button>
            <button id="btnAnalise" onclick="mostrarTelaAnalise()" class="btn btn-gray">üìà An√°lise</button>
            <button id="btnConfig" onclick="mostrarTela('config')" class="btn btn-gray">‚öôÔ∏è Configura√ß√µes</button>
                </div>
            </div>
        </div>

        <!-- Status de Salvamento -->
        <div class="card bg-green-light">
            <div class="flex items-center gap-2">
                <span class="status-dot"></span>
                <strong style="font-weight: 700; color: #ffffff;">Salvamento Autom√°tico Ativo</strong> 
                <span style="color: #ffffff;">‚Äî</span>
                <span style="font-weight: 500; color: #f0f9ff;">Suas configura√ß√µes s√£o salvas automaticamente no navegador</span>
            </div>
        </div>

        <!-- Tela de C√°lculo -->
        <div id="telaCalculo">
            <div class="grid-2">
                <!-- Formul√°rio -->
                <div class="card">
                    <h2 class="font-medium mb-4" style="font-size: 1.25rem;">üì¶ Dados do Produto</h2>
                    
                    <div class="space-y">
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Nome do Produto</label>
                            <input type="text" id="nomeProduto" class="input" placeholder="Digite o nome do produto">
                        </div>

                        <div>
                            <label class="font-medium mb-2" style="display: block;">Custo do Produto (R$)</label>
                            <input type="number" id="custoProduto" class="input" placeholder="0.00" step="0.01">
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Empresa</label>
                                <select id="empresaSelecionada" class="input">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Marketplace</label>
                                <select id="marketplaceSelecionado" class="input">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="font-medium mb-2" style="display: block;">Margem de Lucro (%)</label>
                            <div class="flex gap-2">
                                <input type="number" id="margemLucro" class="input" placeholder="0.00" step="0.01" style="flex: 1;">
                                <select id="tipoMargem" class="input" style="width: auto;">
                                    <option value="venda">Sobre Venda</option>
                                    <option value="custo">Sobre Custo</option>
                                </select>
                            </div>
                            <p class="text-sm text-gray" style="margin-top: 0.25rem;" id="descricaoMargem">
                                Porcentagem de lucro sobre o valor de venda final
                            </p>
                        </div>

                        <div class="bg-yellow-light">
                            <h4 class="font-medium mb-2">üí∞ Configura√ß√£o de Descontos</h4>
                            <div class="grid-2 gap-2">
                                <div>
                                    <label class="font-medium mb-1" style="display: block; font-size: 0.875rem;">Desconto do Marketplace (%)</label>
                                    <input type="number" id="descontoMarketplace" class="input" placeholder="0.00" step="0.01" style="font-size: 0.875rem;">
                                </div>
                                <div>
                                    <label class="font-medium mb-1" style="display: block; font-size: 0.875rem;">Co-participa√ß√£o do Vendedor (%)</label>
                                    <input type="number" id="coParticipacaoVendedor" class="input" placeholder="0.00" step="0.01" style="font-size: 0.875rem;">
                                </div>
                            </div>
                            <p class="text-sm" style="margin-top: 0.5rem; color: #92400e;">
                                <strong>Importante:</strong> O desconto do marketplace √© o desconto total oferecido ao cliente. A co-participa√ß√£o √© a parte desse desconto que o vendedor assume.
                            </p>
                        </div>

                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 1rem;">
                            <h4 class="font-medium mb-2" style="color: #0369a1;">üöö Configura√ß√£o de Frete</h4>
                            
                            <div class="mb-4">
                                <label class="font-medium mb-1" style="display: block; font-size: 0.875rem; color: #0369a1;">M√©dia de Frete p/ Base de Imposto (R$)</label>
                                <input type="number" id="freteParaImposto" class="input" placeholder="0.00" step="0.01" style="font-size: 0.875rem;">
                                <p class="text-sm" style="margin-top: 0.5rem; color: #0369a1;">
                                    <strong>üìã Uso:</strong> Quando o marketplace cobra frete do cliente na nota, mas voc√™ n√£o paga esse frete diretamente. Afeta a base de c√°lculo de <strong>todos os impostos e taxas percentuais</strong>.
                                </p>
                            </div>
                            
                            <div>
                                <label class="font-medium mb-1" style="display: block; font-size: 0.875rem; color: #0369a1;">M√©dia de Frete p/ Comiss√£o do Marketplace (R$)</label>
                                <input type="number" id="freteParaComissao" class="input" placeholder="0.00" step="0.01" style="font-size: 0.875rem;">
                                <p class="text-sm" style="margin-top: 0.5rem; color: #0369a1;">
                                    <strong>üìã Uso:</strong> Quando voc√™ envia o produto e o marketplace cobra comiss√£o sobre (Produto + Frete). Afeta apenas as <strong>comiss√µes do marketplace</strong>.
                                </p>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium">Gastos Adicionais</label>
                                <button onclick="adicionarGastoAdicional()" style="color: #2563eb; cursor: pointer; background: none; border: none; font-weight: 500;">‚ûï Adicionar</button>
                            </div>
                            <div id="gastosAdicionais"></div>
                        </div>
                    </div>
                </div>

                <!-- Resultado -->
                <div class="card">
                    <h2 class="font-medium mb-4" style="font-size: 1.25rem;">üßÆ Resultado do C√°lculo</h2>
                    <div id="resultado">
                        <div class="text-center text-gray p-4">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üßÆ</div>
                            <p>Preencha os dados do produto para ver o c√°lculo</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela de Processamento em Lote -->
        <div id="telaLote" class="hidden">
            <div class="card">
                <h2 class="font-medium mb-4" style="font-size: 1.5rem; color: #2563eb;">üìã SisPre Pro - Processamento em Lote</h2>
                
                <!-- Etapas do Processo -->
                <div class="bg-blue-light mb-6">
                    <h3 class="font-medium mb-3">üöÄ Processo em 4 Etapas:</h3>
                    <div class="grid-2 gap-4">
                        <div class="text-sm">
                            <p><strong>1. üìÅ Upload:</strong> Envie sua planilha (.xlsx ou .csv)</p>
                            <p><strong>2. ‚úÖ Valida√ß√£o:</strong> Verificamos as colunas obrigat√≥rias</p>
                        </div>
                        <div class="text-sm">
                            <p><strong>3. üëÄ Pr√©via:</strong> Confira os dados carregados</p>
                            <p><strong>4. ‚öôÔ∏è Configura√ß√£o:</strong> Aplique empresa e marketplace</p>
                        </div>
                    </div>
                </div>

                <!-- Status do Upload -->
                <div id="statusUpload" class="mb-6">
                    <div class="flex items-center gap-4 mb-4">
                        <h3 class="font-medium">üìÅ 1. Upload da Planilha</h3>
                        <div id="indicadorEtapa1" class="w-4 h-4 rounded-full bg-gray-300"></div>
                    </div>
                    
                    <!-- √Årea de Upload -->
                    <div id="areaUpload" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50">
                        <div class="mb-4">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                            <h4 class="font-medium mb-2">Selecione ou arraste sua planilha</h4>
                            <p class="text-sm text-gray">Formatos aceitos: .xlsx, .xls, .csv</p>
                        </div>
                        
                        <input type="file" id="inputArquivo" accept=".xlsx,.xls,.csv" style="display: none;" onchange="processarArquivo(event)">
                        <button onclick="document.getElementById('inputArquivo').click()" class="btn btn-blue">
                            üìÅ Escolher Arquivo
                        </button>
                        
                        <div class="text-sm text-gray mt-4">
                            <p><strong>Colunas obrigat√≥rias:</strong></p>
                            <p>‚Ä¢ C√≥digo do Produto ‚Ä¢ Nome do Produto ‚Ä¢ Custo do Produto</p>
                            <p class="mt-2" style="color: #2563eb;"><strong>üí° Dica:</strong> Voc√™ pode arrastar o arquivo diretamente para esta √°rea!</p>
                        </div>
                    </div>
                    
                    <!-- Progresso do Upload -->
                    <div id="progressoUpload" class="hidden mt-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="animate-pulse w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm">Processando arquivo...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="barraProgresso" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Valida√ß√£o -->
                <div id="statusValidacao" class="mb-6 hidden">
                    <div class="flex items-center gap-4 mb-4">
                        <h3 class="font-medium">‚úÖ 2. Valida√ß√£o dos Dados</h3>
                        <div id="indicadorEtapa2" class="w-4 h-4 rounded-full bg-gray-300"></div>
                    </div>
                    
                    <div id="resultadoValidacao"></div>
                </div>

                <!-- Pr√©via dos Dados -->
                <div id="statusPrevia" class="mb-6 hidden">
                    <div class="flex items-center gap-4 mb-4">
                        <h3 class="font-medium">üëÄ 3. Pr√©via dos Dados</h3>
                        <div id="indicadorEtapa3" class="w-4 h-4 rounded-full bg-gray-300"></div>
                    </div>
                    
                    <div id="tabelaPrevia"></div>
                </div>

                <!-- Configura√ß√£o para Processamento -->
                <div id="statusConfiguracao" class="mb-6 hidden">
                    <div class="flex items-center gap-4 mb-4">
                        <h3 class="font-medium">‚öôÔ∏è 4. Configura√ß√£o do Processamento</h3>
                        <div id="indicadorEtapa4" class="w-4 h-4 rounded-full bg-gray-300"></div>
                    </div>
                    
                    <div class="bg-yellow-light p-4 rounded">
                        <p class="font-medium mb-3">Configure os par√¢metros para aplicar em todos os produtos:</p>
                        
                        <div class="grid-2 gap-4 mb-4">
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Empresa</label>
                                <select id="empresaLote" class="input">
                                    <option value="">Selecione a empresa...</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Marketplace</label>
                                <select id="marketplaceLote" class="input">
                                    <option value="">Selecione o marketplace...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid-2 gap-4 mb-4">
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Margem de Lucro (%)</label>
                                <input type="number" id="margemLote" class="input" placeholder="0.00" step="0.01">
                            </div>
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Tipo de Margem</label>
                                <select id="tipoMargemLote" class="input">
                                    <option value="venda">Sobre Venda</option>
                                    <option value="custo">Sobre Custo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid-2 gap-4 mb-4">
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Desconto Marketplace (%)</label>
                                <input type="number" id="descontoLote" class="input" placeholder="0.00" step="0.01" value="0">
                            </div>
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Co-participa√ß√£o (%)</label>
                                <input type="number" id="coParticipacaoLote" class="input" placeholder="0.00" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="grid-2 gap-4 mb-4">
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Frete para Base de Imposto (R$)</label>
                                <input type="number" id="freteLote" class="input" placeholder="0.00" step="0.01" value="0">
                            </div>
                            <div>
                                <label class="font-medium mb-2" style="display: block;">Frete para Comiss√£o Marketplace (R$)</label>
                                <input type="number" id="freteComissaoLote" class="input" placeholder="0.00" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <button id="btnProcessarLote" onclick="processarLote()" class="btn btn-green" style="width: 100%;" disabled>
                            üöÄ Processar Todos os Produtos
                        </button>
                    </div>
                </div>

                <!-- Resultados do Processamento -->
                <div id="statusResultados" class="mb-6 hidden">
                    <div class="flex items-center gap-4 mb-4">
                        <h3 class="font-medium">üìä 5. Resultados do Processamento</h3>
                        <div id="indicadorEtapa5" class="w-4 h-4 rounded-full bg-green-500"></div>
                    </div>
                    
                    <div id="tabelaResultados"></div>
                    
                    <div class="text-center mt-4">
                        <button onclick="exportarResultados()" class="btn btn-green" disabled>
                            üì• Exportar Resultados
                        </button>
                    </div>
                </div>

                <!-- Bot√£o para Resetar -->
                <div class="text-center">
                    <button onclick="resetarProcessamento()" class="btn btn-red">
                        üîÑ Come√ßar Novamente
                    </button>
                </div>
            </div>
        </div>


        <!-- Tela de An√°lise Reversa -->
        <div id="telaAnalise" style="display: none;">
            <div class="card">
                <h2 class="font-medium mb-4" style="font-size: 1.5rem; color: #2d3748;">
                    üìà An√°lise Reversa de Cen√°rios
                </h2>
                <p style="color: #718096; margin-bottom: 2rem;">
                    Simule diferentes cen√°rios de promo√ß√µes e descontos para avaliar a viabilidade de participar.
                    Insira o pre√ßo de venda desejado e veja automaticamente qual seria seu lucro e margem.
                </p>

                <!-- Dados Base do Produto -->
                <div class="card" style="background: rgba(102, 126, 234, 0.05); border: 2px solid rgba(102, 126, 234, 0.2);">
                    <h3 class="font-medium mb-3" style="font-size: 1.1rem; color: #2d3748;">
                        üì¶ Dados Base do Produto
                    </h3>
                    <div class="grid-3">
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Pre√ßo de Venda Atual (R$)</label>
                            <input type="number" id="analisePrecoVendaBase" class="input" placeholder="0.00" step="0.01">
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Custo do Produto (R$)</label>
                            <input type="number" id="analiseCustoBase" class="input" placeholder="0.00" step="0.01">
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">üì¶ Valor do Frete (R$)</label>
                            <input type="number" id="analiseFreteBase" class="input" placeholder="0.00" step="0.01" value="0">
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Empresa</label>
                            <select id="analiseEmpresaBase" class="input">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Marketplace</label>
                            <select id="analiseMarketplaceBase" class="input">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">
                                <input type="checkbox" id="analiseFreteParaImpostoBase" style="margin-right: 0.5rem;">
                                Frete base p/ imposto
                            </label>
                        </div>
                        <div>
                            <label class="font-medium mb-2" style="display: block;">
                                <input type="checkbox" id="analiseFreteParaComissaoBase" style="margin-right: 0.5rem;">
                                Frete base p/ comiss√£o
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Container de Cen√°rios -->
                <div id="listaCenarios" style="margin-top: 2rem;">
                    <!-- Os cen√°rios ser√£o inseridos aqui dinamicamente -->
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex gap-2" style="margin-top: 1.5rem;">
                    <button onclick="adicionarCenario()" class="btn btn-blue">
                        ‚ûï Adicionar Cen√°rio
                    </button>
                    <button onclick="calcularTodosCenarios()" class="btn btn-green">
                        üîÑ Calcular Todos os Cen√°rios
                    </button>
                </div>

                <!-- Tabela de Compara√ß√£o -->
                <div id="tabelaComparacao" style="margin-top: 2rem;">
                    <!-- A tabela ser√° inserida aqui dinamicamente -->
                </div>
            </div>
        </div>


        <!-- Tela de Configura√ß√µes -->
        <div id="telaConfig" class="hidden">
            <!-- Backup -->
            <div class="card">
                <h2 class="font-medium mb-4" style="font-size: 1.25rem;">üíæ Backup e Restaura√ß√£o</h2>
                <div class="grid-3">
                    <button onclick="exportarConfiguracoes()" class="btn btn-blue">üíæ Fazer Backup</button>
                    <label class="btn btn-green text-center" style="cursor: pointer;">
                        üìÅ Restaurar Backup
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarConfiguracoes(event)">
                    </label>
                    <button onclick="limparTodosDados()" class="btn btn-red">üóëÔ∏è Limpar Tudo</button>
                </div>
            </div>

            <div class="grid-2">
                <!-- Empresas -->
                <div class="card">
                    <h2 class="font-medium mb-4" style="font-size: 1.25rem;">üè¢ Configurar Empresas</h2>
                    
                    <div class="space-y">
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Nome da Empresa</label>
                            <input type="text" id="nomeNovaEmpresa" class="input" placeholder="Digite o nome da empresa">
                        </div>

                        <div style="background: #fef3cd; border: 1px solid #f59e0b; border-radius: 6px; padding: 1rem;">
                            <label class="font-medium mb-2" style="display: block; color: #92400e;">üìä Imposto Total da Empresa (%)</label>
                            <input type="number" id="impostoEmpresa" class="input" placeholder="18.00" step="0.01" style="font-size: 0.875rem;">
                            <p class="text-sm" style="margin-top: 0.5rem; color: #92400e;">
                                <strong>Obrigat√≥rio:</strong> Soma de todos os impostos (ICMS, PIS, COFINS, etc.) que incidem sobre vendas. Este valor ser√° usado para calcular impostos sobre fretes.
                            </p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium">Outros Custos da Empresa</label>
                                <button onclick="adicionarCustoEmpresa()" style="color: #2563eb; cursor: pointer; background: none; border: none; font-weight: 500;">‚ûï Adicionar</button>
                            </div>
                            <p class="text-sm text-gray mb-2">Custos operacionais como embalagem, m√£o de obra, etc. (n√£o incluir impostos aqui)</p>
                            <div id="custosNovaEmpresa"></div>
                        </div>

                        <button onclick="salvarEmpresa()" class="btn btn-blue" style="width: 100%;">üíæ Salvar Empresa</button>
                        
                        <div class="bg-yellow-light text-sm">
                            <strong>üí° Dica:</strong> Para editar uma empresa j√° cadastrada, clique no bot√£o "Editar" na lista abaixo. 
                            <strong>O campo "Imposto" √© obrigat√≥rio</strong> e ser√° usado para calcular impostos sobre fretes.
                        </div>

                        <div>
                            <h3 class="font-medium mb-2">Empresas Cadastradas</h3>
                            <div id="listaEmpresas"></div>
                        </div>
                    </div>
                </div>

                <!-- Marketplaces -->
                <div class="card">
                    <h2 class="font-medium mb-4" style="font-size: 1.25rem;">üõí Configurar Marketplaces</h2>
                    
                    <div class="space-y">
                        <div>
                            <label class="font-medium mb-2" style="display: block;">Nome do Marketplace</label>
                            <input type="text" id="nomeNovoMarketplace" class="input" placeholder="Digite o nome do marketplace">
                        </div>

                        <div style="background: #f0fdf4; border: 1px solid #16a34a; border-radius: 6px; padding: 1rem;">
                            <label class="font-medium mb-2" style="display: block; color: #15803d;">üè™ Comiss√£o do Marketplace (%)</label>
                            <input type="number" id="comissaoMarketplace" class="input" placeholder="12.00" step="0.01" style="font-size: 0.875rem;">
                            <p class="text-sm" style="margin-top: 0.5rem; color: #15803d;">
                                <strong>Obrigat√≥rio:</strong> Porcentagem de comiss√£o que o marketplace cobra sobre vendas. Este valor ser√° usado para calcular comiss√£o sobre fretes.
                            </p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium">Outras Taxas do Marketplace</label>
                                <button onclick="adicionarCustoMarketplace()" style="color: #16a34a; cursor: pointer; background: none; border: none; font-weight: 500;">‚ûï Adicionar</button>
                            </div>
                            <p class="text-sm text-gray mb-2">Outras taxas como Mercado Pago, taxas fixas, etc. (n√£o incluir comiss√£o principal aqui)</p>
                            <div id="custosNovoMarketplace"></div>
                        </div>

                        <button onclick="salvarMarketplace()" class="btn btn-green" style="width: 100%;">üíæ Salvar Marketplace</button>
                        
                        <div class="bg-green-light text-sm">
                            <strong>üí° Dica:</strong> Para editar um marketplace j√° cadastrado, clique no bot√£o "Editar" na lista abaixo. 
                            <strong>O campo "Comiss√£o" √© obrigat√≥rio</strong> e ser√° usado para calcular comiss√µes sobre fretes.
                        </div>

                        <div>
                            <h3 class="font-medium mb-2">Marketplaces Cadastrados</h3>
                            <div id="listaMarketplaces"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instru√ß√µes -->
        <div class="card">
            <h3 class="font-medium mb-4" style="font-size: 1.125rem;">üìã Como Usar Este Sistema</h3>
            <div class="grid-2">
                <div>
                    <h4 class="font-medium mb-2">üíæ Salvamento de Dados:</h4>
                    <ul style="list-style: disc; padding-left: 1.5rem; color: #6b7280;">
                        <li>Suas configura√ß√µes s√£o <strong>salvas automaticamente</strong> no navegador</li>
                        <li>Os dados <strong>n√£o se perdem</strong> ao fechar o programa</li>
                        <li>Fa√ßa backup regularmente para maior seguran√ßa</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium mb-2">üñ•Ô∏è Como Usar no PC:</h4>
                    <ul style="list-style: disc; padding-left: 1.5rem; color: #6b7280;">
                        <li>Clique com bot√£o direito nesta p√°gina ‚Üí "Salvar como"</li>
                        <li>Salve como <strong>"SisPre.html"</strong> no seu computador</li>
                        <li>Abra o arquivo no navegador - funciona 100% offline!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°vel global para armazenar cen√°rios de an√°lise
        var cenarios = [];

            // Dados do sistema
        var empresas = [];
        var marketplaces = [];
        var gastosAdicionais = [];
        var custosNovaEmpresa = [];
        var custosNovoMarketplace = [];
        
        // Dados do processamento em lote
        var dadosOriginais = [];
        var colunasMapeadas = {};
        var arquivoCarregado = false;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            configurarEventos();
            atualizarListas();
            calcular();
        });

        // Configurar eventos
        function configurarEventos() {
            document.getElementById('btnCalculo').onclick = function() { mostrarTela('calculo'); };
            document.getElementById('btnLote').onclick = function() { mostrarTela('lote'); };
            document.getElementById('btnConfig').onclick = function() { mostrarTela('config'); };
            document.getElementById('btnAnalise').onclick = function() { mostrarTela('analise'); };
            
            document.getElementById('custoProduto').oninput = calcular;
            document.getElementById('margemLucro').oninput = calcular;
            document.getElementById('descontoMarketplace').oninput = calcular;
            document.getElementById('coParticipacaoVendedor').oninput = calcular;
            document.getElementById('freteParaImposto').oninput = calcular;
            document.getElementById('freteParaComissao').oninput = calcular;
            document.getElementById('tipoMargem').onchange = function() {
                atualizarDescricaoMargem();
                calcular();
            };
            document.getElementById('empresaSelecionada').onchange = calcular;
            document.getElementById('marketplaceSelecionado').onchange = calcular;
            
            atualizarDescricaoMargem();
        }

        // Mostrar tela
        function mostrarTela(tela) {
            document.getElementById('telaCalculo').classList.toggle('hidden', tela !== 'calculo');
            document.getElementById('telaLote').classList.toggle('hidden', tela !== 'lote');
            document.getElementById('telaConfig').classList.toggle('hidden', tela !== 'config');
            
            // Atualizar bot√µes
            document.getElementById('btnCalculo').className = tela === 'calculo' ? 'btn btn-blue' : 'btn btn-gray';
            document.getElementById('btnLote').className = tela === 'lote' ? 'btn btn-blue' : 'btn btn-gray';
            document.getElementById('btnConfig').className = tela === 'config' ? 'btn btn-blue' : 'btn btn-gray';
            
            // Se estiver indo para tela de lote, atualizar selects
            if (tela === 'lote') {
                atualizarSelectsLote();
            }
        }

        // Carregar dados salvos
        function carregarDados() {
            try {
                var empresasSalvas = JSON.parse(localStorage.getItem('sisPre_empresas') || '[]');
                var marketplacesSalvos = JSON.parse(localStorage.getItem('sisPre_marketplaces') || '[]');
                
                if (empresasSalvas.length === 0) {
                    empresas = [{
                        id: 1,
                        nome: "Zabereta",
                        impostoPercentual: 9.2,
                        custosFixos: [
                            { nome: "Taxa", valor: 1.47, tipo: "fixo" }
                        ]
                    }];
                } else {
                    empresas = empresasSalvas;
                    for (var i = 0; i < empresas.length; i++) {
                        if (typeof empresas[i].impostoPercentual === 'undefined') {
                            empresas[i].impostoPercentual = 0;
                        }
                    }
                }
                
                if (marketplacesSalvos.length === 0) {
                    marketplaces = [
                        {
                            id: 1,
                            nome: "Amazon",
                            comissaoPercentual: 16.0,
                            custosFixos: [
                                { nome: "Taxa", valor: 6.00, tipo: "fixo" }
                            ]
                        },
                        {
                            id: 2,
                            nome: "Mercado Livre",
                            comissaoPercentual: 11.0,
                            custosFixos: [
                                { nome: "Taxa Mercado Pago", valor: 4.99, tipo: "porcentagem" },
                                { nome: "Taxa de An√∫ncio", valor: 1.00, tipo: "fixo" }
                            ]
                        }
                    ];
                } else {
                    marketplaces = marketplacesSalvos;
                    for (var i = 0; i < marketplaces.length; i++) {
                        if (typeof marketplaces[i].comissaoPercentual === 'undefined') {
                            marketplaces[i].comissaoPercentual = 0;
                        }
                    }
                }
                
                salvarDados();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Salvar dados
        function salvarDados() {
            localStorage.setItem('sisPre_empresas', JSON.stringify(empresas));
            localStorage.setItem('sisPre_marketplaces', JSON.stringify(marketplaces));
        }

        // Atualizar listas
        function atualizarListas() {
            var selectEmpresa = document.getElementById('empresaSelecionada');
            var selectMarketplace = document.getElementById('marketplaceSelecionado');
            
            selectEmpresa.innerHTML = '<option value="">Selecione...</option>';
            selectMarketplace.innerHTML = '<option value="">Selecione...</option>';
            
            for (var i = 0; i < empresas.length; i++) {
                var empresa = empresas[i];
                selectEmpresa.innerHTML += '<option value="' + empresa.id + '">' + empresa.nome + '</option>';
            }
            
            for (var i = 0; i < marketplaces.length; i++) {
                var marketplace = marketplaces[i];
                selectMarketplace.innerHTML += '<option value="' + marketplace.id + '">' + marketplace.nome + '</option>';
            }
            
            atualizarListaEmpresas();
            atualizarListaMarketplaces();
        }

        // Atualizar descri√ß√£o da margem
        function atualizarDescricaoMargem() {
            var tipo = document.getElementById('tipoMargem').value;
            var descricao = document.getElementById('descricaoMargem');
            
            if (tipo === 'venda') {
                descricao.textContent = 'Porcentagem de lucro sobre o valor de venda final';
            } else {
                descricao.textContent = 'Porcentagem de lucro sobre o custo do produto';
            }
        }

        // *** FUN√á√ÉO DE C√ÅLCULO PRINCIPAL ***
        function calcular() {
            var custo = parseFloat(document.getElementById('custoProduto').value) || 0;
            var margem = parseFloat(document.getElementById('margemLucro').value) || 0;
            var tipoMargem = document.getElementById('tipoMargem').value;
            var empresaId = document.getElementById('empresaSelecionada').value;
            var marketplaceId = document.getElementById('marketplaceSelecionado').value;
            var descontoMarketplace = parseFloat(document.getElementById('descontoMarketplace').value) || 0;
            var coParticipacaoVendedor = parseFloat(document.getElementById('coParticipacaoVendedor').value) || 0;
            var freteParaImposto = parseFloat(document.getElementById('freteParaImposto').value) || 0;
            var freteParaComissao = parseFloat(document.getElementById('freteParaComissao').value) || 0;
            
            if (custo <= 0) {
                mostrarResultadoVazio();
                return;
            }
            
            var resultado = calcularPrecoIterativo({
                custo: custo,
                margem: margem,
                tipoMargem: tipoMargem,
                empresaId: empresaId,
                marketplaceId: marketplaceId,
                descontoMarketplace: descontoMarketplace,
                coParticipacaoVendedor: coParticipacaoVendedor,
                freteParaImposto: freteParaImposto,
                freteParaComissao: freteParaComissao
            });
            
            if (resultado) {
                mostrarResultadoComDesconto(resultado);
            } else {
                mostrarResultadoVazio();
            }
        }

        // *** FUN√á√ÉO: C√ÅLCULO ITERATIVO PARA MARGEM EXATA ***
        function calcularPrecoIterativo(config) {
            var maxIteracoes = 200;
            var tolerancia = 0.001;
            var precoEstimado = config.custo * 3;
            
            var precoMinimo = config.custo * 1.1;
            var precoMaximo = config.custo * 10;
            
            for (var i = 0; i < maxIteracoes; i++) {
                var resultadoTeste = calcularComPreco(precoEstimado, config);
                var margemReal = resultadoTeste.margemReal;
                var diferenca = Math.abs(margemReal - config.margem);
                
                if (diferenca <= tolerancia) {
                    return resultadoTeste;
                }
                
                if (margemReal < config.margem) {
                    precoMinimo = precoEstimado;
                    precoEstimado = (precoEstimado + precoMaximo) / 2;
                } else {
                    precoMaximo = precoEstimado;
                    precoEstimado = (precoMinimo + precoEstimado) / 2;
                }
                
                if (Math.abs(precoMaximo - precoMinimo) < 0.01) {
                    break;
                }
            }
            
            return calcularComPreco(precoEstimado, config);
        }

        // *** FUN√á√ÉO: CALCULAR COM PRE√áO FIXO ***
        function calcularComPreco(precoSemDesconto, config) {
            var gastosDetalhados = [];
            var gastosFixosTotal = 0;
            var gastosPercentuaisTotal = 0;
            
            // Calcular descontos
            var valorDescontoTotal = precoSemDesconto * (config.descontoMarketplace / 100);
            var valorDescontoVendedor = precoSemDesconto * (config.coParticipacaoVendedor / 100);
            var precoFinalComprador = precoSemDesconto - valorDescontoTotal;
            
            // Para c√°lculos de custos percentuais, usar o pre√ßo correto baseado na situa√ß√£o
            var precoParaCalculo = config.descontoMarketplace > 0 ? precoFinalComprador : precoSemDesconto;
            
            // Obter percentuais principais
            var impostoPercentual = 0;
            var comissaoPercentual = 0;
            
            if (config.empresaId) {
                var empresa = encontrarEmpresa(config.empresaId);
                if (empresa) {
                    impostoPercentual = empresa.impostoPercentual || 0;
                    
                    // Impostos sobre produto
                    var impostoSobreProduto = (precoParaCalculo * impostoPercentual) / 100;
                    gastosPercentuaisTotal += impostoSobreProduto;
                    gastosDetalhados.push({
                        nome: 'Impostos sobre Produto (' + empresa.nome + ')',
                        valor: impostoPercentual,
                        valorCalculado: impostoSobreProduto,
                        categoria: 'empresa'
                    });
                    
                    // Outros custos da empresa
                    for (var i = 0; i < empresa.custosFixos.length; i++) {
                        var custo = empresa.custosFixos[i];
                        var valorCusto = parseFloat(custo.valor) || 0;
                        var valorCalculado = 0;
                        
                        if (custo.tipo === 'fixo') {
                            gastosFixosTotal += valorCusto;
                            valorCalculado = valorCusto;
                        } else {
                            // Custos percentuais da empresa incidem sobre produto + frete para impostos
                            var baseCalculo = precoParaCalculo + config.freteParaImposto;
                            valorCalculado = (baseCalculo * valorCusto) / 100;
                            gastosPercentuaisTotal += valorCalculado;
                        }
                        
                        gastosDetalhados.push({
                            nome: custo.nome + ' (' + empresa.nome + ')',
                            valor: valorCusto,
                            valorCalculado: valorCalculado,
                            categoria: 'empresa'
                        });
                    }
                }
            }
            
            if (config.marketplaceId) {
                var marketplace = encontrarMarketplace(config.marketplaceId);
                if (marketplace) {
                    comissaoPercentual = marketplace.comissaoPercentual || 0;
                    
                    // Comiss√£o sobre produto
                    var comissaoSobreProduto = (precoParaCalculo * comissaoPercentual) / 100;
                    gastosPercentuaisTotal += comissaoSobreProduto;
                    gastosDetalhados.push({
                        nome: 'Comiss√£o sobre Produto (' + marketplace.nome + ')',
                        valor: comissaoPercentual,
                        valorCalculado: comissaoSobreProduto,
                        categoria: 'marketplace'
                    });
                    
                    // Outros custos do marketplace
                    for (var i = 0; i < marketplace.custosFixos.length; i++) {
                        var custo = marketplace.custosFixos[i];
                        var valorCusto = parseFloat(custo.valor) || 0;
                        var valorCalculado = 0;
                        
                        if (custo.tipo === 'fixo') {
                            gastosFixosTotal += valorCusto;
                            valorCalculado = valorCusto;
                        } else {
                            // Custos percentuais do marketplace incidem sobre produto + frete para comiss√£o
                            var baseCalculo = precoParaCalculo + config.freteParaComissao;
                            valorCalculado = (baseCalculo * valorCusto) / 100;
                            gastosPercentuaisTotal += valorCalculado;
                        }
                        
                        gastosDetalhados.push({
                            nome: custo.nome + ' (' + marketplace.nome + ')',
                            valor: valorCusto,
                            valorCalculado: valorCalculado,
                            categoria: 'marketplace'
                        });
                    }
                }
            }
            
            // Gastos adicionais
            for (var i = 0; i < gastosAdicionais.length; i++) {
                var gasto = gastosAdicionais[i];
                var valor = parseFloat(gasto.valor) || 0;
                var valorCalculado = 0;
                
                if (gasto.tipo === 'fixo') {
                    gastosFixosTotal += valor;
                    valorCalculado = valor;
                } else {
                    var baseCalculo = precoParaCalculo + config.freteParaImposto;
                    valorCalculado = (baseCalculo * valor) / 100;
                    gastosPercentuaisTotal += valorCalculado;
                }
                
                gastosDetalhados.push({
                    nome: gasto.nome,
                    valor: valor,
                    valorCalculado: valorCalculado,
                    categoria: 'adicional'
                });
            }
            
            // Custos sobre fretes
            if (config.freteParaImposto > 0 && impostoPercentual > 0) {
                var impostoFrete = (config.freteParaImposto * impostoPercentual) / 100;
                gastosPercentuaisTotal += impostoFrete;
                gastosDetalhados.push({
                    nome: 'Impostos sobre Frete (' + impostoPercentual.toFixed(1) + '% de R$ ' + config.freteParaImposto.toFixed(2) + ')',
                    valor: impostoPercentual,
                    valorCalculado: impostoFrete,
                    categoria: 'frete'
                });
            }
            
            if (config.freteParaComissao > 0 && comissaoPercentual > 0) {
                var comissaoFrete = (config.freteParaComissao * comissaoPercentual) / 100;
                gastosPercentuaisTotal += comissaoFrete;
                gastosDetalhados.push({
                    nome: 'Comiss√£o sobre Frete (' + comissaoPercentual.toFixed(1) + '% de R$ ' + config.freteParaComissao.toFixed(2) + ')',
                    valor: comissaoPercentual,
                    valorCalculado: comissaoFrete,
                    categoria: 'frete'
                });
            }
            
            // *** CORRE√á√ÉO CR√çTICA v4.1: LUCRO BASEADO NO PRE√áO FINAL DO CLIENTE ***
            var totalCustosOperacionais = gastosFixosTotal + gastosPercentuaisTotal;
            
            // *** ADICIONAR CO-PARTICIPA√á√ÉO COMO CUSTO OPERACIONAL NOS DETALHES ***
            // A co-participa√ß√£o do vendedor √© um custo que ele assume do desconto
            if (config.coParticipacaoVendedor > 0) {
                totalCustosOperacionais += valorDescontoVendedor;
                
                // ADICIONAR NO DETALHAMENTO VIS√çVEL
                gastosDetalhados.push({
                    nome: 'Co-participa√ß√£o em Desconto',
                    valor: config.coParticipacaoVendedor,
                    valorCalculado: valorDescontoVendedor,
                    categoria: 'desconto'
                });
            }
            
            // *** C√ÅLCULO FINAL DO LUCRO ***
            var lucroLiquido = precoFinalComprador - totalCustosOperacionais - config.custo;
            
            // *** CORRE√á√ÉO CR√çTICA v4.1: MARGEM SEMPRE SOBRE PRE√áO FINAL DO CLIENTE ***
            var margemReal;
            if (config.tipoMargem === 'venda') {
                // SEMPRE usar o pre√ßo final que o cliente paga como base
                margemReal = (lucroLiquido / precoFinalComprador) * 100;
            } else {
                // Margem sobre custo
                margemReal = (lucroLiquido / config.custo) * 100;
            }
            
            return {
                precoVendaSemDesconto: precoSemDesconto,
                precoFinalComprador: precoFinalComprador,
                custoBase: config.custo,
                gastosFixosTotal: gastosFixosTotal,
                gastosPercentuaisTotal: gastosPercentuaisTotal,
                totalCustosOperacionais: totalCustosOperacionais,
                valorDescontoTotal: valorDescontoTotal,
                valorDescontoVendedor: valorDescontoVendedor,
                lucroLiquido: lucroLiquido,
                margemReal: margemReal,
                gastosDetalhados: gastosDetalhados,
                descontoMarketplace: config.descontoMarketplace,
                coParticipacaoVendedor: config.coParticipacaoVendedor,
                freteParaImposto: config.freteParaImposto,
                freteParaComissao: config.freteParaComissao,
                margemDesejada: config.margem,
                tipoMargem: config.tipoMargem
            };
        }

        // Fun√ß√µes auxiliares
        function encontrarEmpresa(id) {
            for (var i = 0; i < empresas.length; i++) {
                if (empresas[i].id == id) return empresas[i];
            }
            return null;
        }

        function encontrarMarketplace(id) {
            for (var i = 0; i < marketplaces.length; i++) {
                if (marketplaces[i].id == id) return marketplaces[i];
            }
            return null;
        }

        // *** FUN√á√ÉO DE EXIBI√á√ÉO CORRIGIDA v4.1 ***
        function mostrarResultadoComDesconto(dados) {
            var temDesconto = dados.descontoMarketplace > 0;
            var temFreteImposto = dados.freteParaImposto > 0;
            var temFreteComissao = dados.freteParaComissao > 0;
            
            var html = '';
            
            if (temDesconto) {
                // Se√ß√£o de pre√ßos principais
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">';
                
                // Pre√ßo original
                html += '<div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 16px; padding: 1.5rem; text-align: center; backdrop-filter: blur(10px);">';
                html += '<p style="font-size: 0.875rem; color: #667eea; font-weight: 600; margin: 0;">Pre√ßo Original (Sem Desconto)</p>';
                html += '<p style="font-size: 1.75rem; font-weight: 800; color: #5a67d8; margin: 0.5rem 0 0 0;">R$ ' + dados.precoVendaSemDesconto.toFixed(2) + '</p>';
                html += '</div>';
                
                // Pre√ßo final para comprador
                html += '<div style="background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%); border: 1px solid rgba(72, 187, 120, 0.2); border-radius: 16px; padding: 1.5rem; text-align: center; backdrop-filter: blur(10px);">';
                html += '<p style="font-size: 0.875rem; color: #48bb78; font-weight: 600; margin: 0;">Pre√ßo Final p/ Comprador</p>';
                html += '<p style="font-size: 1.75rem; font-weight: 800; color: #38a169; margin: 0.5rem 0 0 0;">R$ ' + dados.precoFinalComprador.toFixed(2) + '</p>';
                if (temFreteImposto || temFreteComissao) {
                    html += '<p style="font-size: 0.75rem; color: #48bb78; margin: 0.25rem 0 0 0; font-weight: 500;">+ Frete: ';
                    if (temFreteImposto) html += 'R$ ' + dados.freteParaImposto.toFixed(2) + ' (impostos)';
                    if (temFreteImposto && temFreteComissao) html += ' + ';
                    if (temFreteComissao) html += 'R$ ' + dados.freteParaComissao.toFixed(2) + ' (comiss√£o)';
                    html += '</p>';
                }
                html += '<p style="font-size: 0.75rem; color: #48bb78; margin: 0.25rem 0 0 0; font-weight: 500;">Desconto: ' + dados.descontoMarketplace.toFixed(1) + '% (R$ ' + dados.valorDescontoTotal.toFixed(2) + ')</p>';
                html += '</div>';
                
                html += '</div>';
                
            } else {
                // Sem desconto - exibi√ß√£o simples
                html += '<div style="background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%); border: 1px solid rgba(72, 187, 120, 0.2); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; backdrop-filter: blur(10px);">';
                html += '<div style="text-align: center;">';
                html += '<p style="font-size: 0.875rem; color: #48bb78; font-weight: 600; margin: 0;">Pre√ßo de Venda</p>';
                html += '<p style="font-size: 2.25rem; font-weight: 800; color: #38a169; margin: 0.5rem 0;">R$ ' + dados.precoVendaSemDesconto.toFixed(2) + '</p>';
                if (temFreteImposto || temFreteComissao) {
                    html += '<p style="font-size: 0.875rem; color: #48bb78; margin: 0; font-weight: 500;">+ Frete: ';
                    if (temFreteImposto) html += 'R$ ' + dados.freteParaImposto.toFixed(2) + ' (impostos)';
                    if (temFreteImposto && temFreteComissao) html += ' + ';
                    if (temFreteComissao) html += 'R$ ' + dados.freteParaComissao.toFixed(2) + ' (comiss√£o)';
                    html += '</p>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            // Breakdown DETALHADO de custos
            html += '<div style="border-bottom: 2px solid rgba(226, 232, 240, 0.8); padding-bottom: 1rem; margin-bottom: 1.5rem;">';
            html += '<h3 style="font-weight: 700; margin: 0; font-size: 1.125rem; color: #4a5568;">üìä Detalhamento Completo de Custos</h3>';
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">';
            html += '<span style="color: #6b7280;">üí∞ Custo Base do Produto:</span>';
            html += '<span style="font-weight: 500; text-align: right; min-width: 90px;">R$ ' + dados.custoBase.toFixed(2) + '</span>';
            html += '<span style="min-width: 50px;"></span>';
            html += '</div>';
            
            // Listar todos os gastos individualmente
            if (dados.gastosDetalhados && dados.gastosDetalhados.length > 0) {
                for (var i = 0; i < dados.gastosDetalhados.length; i++) {
                    var gasto = dados.gastosDetalhados[i];
                    var icone = 'üìã';
                    
                    if (gasto.categoria === 'frete') {
                        icone = 'üöö';
                    } else if (gasto.categoria === 'marketplace') {
                        icone = 'üè™';
                    } else if (gasto.categoria === 'empresa') {
                        icone = 'üè¢';
                    }
                    
                    html += '<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; margin-bottom: 0.25rem;">';
                    html += '<span style="color: #6b7280; font-size: 0.875rem;">' + icone + ' ' + gasto.nome + ':</span>';
                    html += '<span style="font-weight: 500; font-size: 0.875rem; text-align: right; min-width: 90px;">R$ ' + gasto.valorCalculado.toFixed(2) + '</span>';
                    html += '<span style="font-size: 0.75rem; color: #6b7280; min-width: 50px;">(' + gasto.valor.toFixed(1) + (gasto.valorCalculado === gasto.valor ? '' : '%') + ')</span>';
                    html += '</div>';
                }
            }
            
            var totalCustos = dados.custoBase + dados.totalCustosOperacionais;
            
            html += '<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; padding-top: 0.5rem; border-top: 1px solid #e5e7eb; margin-bottom: 1rem;">';
            html += '<span style="color: #374151; font-weight: 600;">üí∏ Total de Custos:</span>';
            html += '<span style="font-weight: 600; color: #374151; text-align: right; min-width: 90px;">R$ ' + totalCustos.toFixed(2) + '</span>';
            html += '<span style="min-width: 50px;"></span>';
            html += '</div>';
            
            // *** SE√á√ÉO DE LUCRO SIMPLIFICADA ***
            html += '<div style="background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%); border: 2px solid rgba(72, 187, 120, 0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;">';
            html += '<h4 style="color: #15803d; font-weight: 800; margin: 0 0 1rem 0; font-size: 1.125rem;">üí∞ Lucro Final</h4>';
            
            html += '<div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1rem;">';
            html += '<div>';
            html += '<p style="color: #15803d; margin: 0; font-weight: 600; font-size: 0.875rem;">F√≥rmula:</p>';
            html += '<p style="color: #15803d; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Lucro = <strong>Pre√ßo Final Cliente</strong> - Custos</p>';
            html += '<p style="color: #15803d; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Lucro = R$ ' + dados.precoFinalComprador.toFixed(2) + ' - R$ ' + totalCustos.toFixed(2) + '</p>';
            html += '</div>';
            html += '<div style="text-align: right;">';
            html += '<p style="color: #15803d; margin: 0; font-size: 0.875rem; font-weight: 500;">Lucro Final:</p>';
            html += '<p style="color: #15803d; margin: 0; font-size: 1.5rem; font-weight: 800;">R$ ' + dados.lucroLiquido.toFixed(2) + '</p>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            
            // Mostrar margens
            html += '<div style="background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 16px; padding: 1.5rem; backdrop-filter: blur(10px);">';
            html += '<h4 style="font-weight: 700; margin: 0 0 1rem 0; color: #475569;">üìà An√°lise de Margem de Lucro</h4>';
            
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%); padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.2);">';
            html += '<span style="font-weight: 700; color: #15803d;">‚úÖ Margem ' + (dados.tipoMargem === 'venda' ? 'Sobre Venda' : 'Sobre Custo') + ' (configurada: ' + dados.margemDesejada.toFixed(1) + '%):</span>';
            html += '<span style="font-weight: 800; color: #15803d;">' + dados.margemReal.toFixed(2) + '%</span>';
            html += '</div>';
            
            // Calcular margem alternativa para refer√™ncia
            var margemAlternativa;
            if (dados.tipoMargem === 'venda') {
                margemAlternativa = (dados.lucroLiquido / dados.custoBase) * 100;
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
                html += '<span style="color: #718096; font-size: 0.875rem; font-weight: 500;">üìä Margem Sobre Custo (refer√™ncia):</span>';
                html += '<span style="font-weight: 600; color: #718096; font-size: 0.875rem;">' + margemAlternativa.toFixed(2) + '%</span>';
                html += '</div>';
            } else {
                margemAlternativa = (dados.lucroLiquido / dados.precoFinalComprador) * 100;
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
                html += '<span style="color: #718096; font-size: 0.875rem; font-weight: 500;">üìä Margem Sobre Venda (padr√£o mercado):</span>';
                html += '<span style="font-weight: 600; color: #718096; font-size: 0.875rem;">' + margemAlternativa.toFixed(2) + '%</span>';
                html += '</div>';
            }
            
            html += '<p style="font-size: 0.75rem; color: #15803d; margin: 1rem 0 0 0; font-style: italic; font-weight: 600; background: rgba(34, 197, 94, 0.1); padding: 0.5rem; border-radius: 6px;">';
            var diferenca = Math.abs(dados.margemReal - dados.margemDesejada);
            html += 'üìä <strong>Resultado:</strong> ';
            if (temDesconto) {
                html += 'Margem calculada sobre <strong>Pre√ßo Final do Cliente</strong> (R$ ' + dados.precoFinalComprador.toFixed(2) + '). ';
                html += 'Lucro R$ ' + dados.lucroLiquido.toFixed(2) + ' √∑ R$ ' + dados.precoFinalComprador.toFixed(2) + ' = ' + dados.margemReal.toFixed(2) + '%. ';
            } else {
                html += 'Margem calculada sobre pre√ßo de venda. ';
            }
            html += 'Diferen√ßa da meta: ' + diferenca.toFixed(3) + '%';
            html += '</p>';
            
            html += '</div>';
            
            document.getElementById('resultado').innerHTML = html;
        }

        // Mostrar resultado vazio
        function mostrarResultadoVazio() {
            document.getElementById('resultado').innerHTML = 
                '<div style="text-align: center; color: #718096; padding: 3rem; background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 16px; backdrop-filter: blur(10px);">' +
                    '<div style="font-size: 4rem; margin-bottom: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));">üßÆ</div>' +
                    '<p style="font-size: 1.125rem; font-weight: 600; margin: 0;">Preencha os dados do produto para ver o c√°lculo</p>' +
                    '<p style="font-size: 0.875rem; margin: 0.5rem 0 0 0; opacity: 0.8;">Digite o custo, selecione empresa e marketplace</p>' +
                '</div>';
        }

        // Gastos adicionais
        function adicionarGastoAdicional() {
            gastosAdicionais.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarGastosAdicionais();
        }

        function atualizarGastosAdicionais() {
            var container = document.getElementById('gastosAdicionais');
            container.innerHTML = '';
            
            for (var i = 0; i < gastosAdicionais.length; i++) {
                var gasto = gastosAdicionais[i];
                container.innerHTML += 
                    '<div class="input-row">' +
                        '<input type="text" value="' + gasto.nome + '" onchange="gastosAdicionais[' + i + '].nome = this.value; calcular();" placeholder="Nome do gasto" class="input-small" style="flex: 1;">' +
                        '<input type="number" step="0.01" value="' + gasto.valor + '" onchange="gastosAdicionais[' + i + '].valor = this.value; calcular();" placeholder="Valor" class="input-small" style="width: 80px;">' +
                        '<select onchange="gastosAdicionais[' + i + '].tipo = this.value; calcular();" class="input-small" style="width: 80px;">' +
                            '<option value="fixo"' + (gasto.tipo === 'fixo' ? ' selected' : '') + '>R$</option>' +
                            '<option value="porcentagem"' + (gasto.tipo === 'porcentagem' ? ' selected' : '') + '>%</option>' +
                        '</select>' +
                        '<button onclick="removerGastoAdicional(' + i + ')" style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 4px;">üóëÔ∏è</button>' +
                    '</div>';
            }
        }

        function removerGastoAdicional(index) {
            gastosAdicionais.splice(index, 1);
            atualizarGastosAdicionais();
            calcular();
        }

        // Empresas
        function adicionarCustoEmpresa() {
            custosNovaEmpresa.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarCustosNovaEmpresa();
        }

        function atualizarCustosNovaEmpresa() {
            var container = document.getElementById('custosNovaEmpresa');
            container.innerHTML = '';
            
            for (var i = 0; i < custosNovaEmpresa.length; i++) {
                var custo = custosNovaEmpresa[i];
                container.innerHTML += 
                    '<div class="input-row">' +
                        '<input type="text" value="' + custo.nome + '" onchange="custosNovaEmpresa[' + i + '].nome = this.value;" placeholder="Nome do custo" class="input-small" style="flex: 1;">' +
                        '<input type="number" step="0.01" value="' + custo.valor + '" onchange="custosNovaEmpresa[' + i + '].valor = this.value;" placeholder="Valor" class="input-small" style="width: 80px;">' +
                        '<select onchange="custosNovaEmpresa[' + i + '].tipo = this.value;" class="input-small" style="width: 80px;">' +
                            '<option value="fixo"' + (custo.tipo === 'fixo' ? ' selected' : '') + '>R$</option>' +
                            '<option value="porcentagem"' + (custo.tipo === 'porcentagem' ? ' selected' : '') + '>%</option>' +
                        '</select>' +
                        '<button onclick="removerCustoEmpresa(' + i + ')" style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 4px;">üóëÔ∏è</button>' +
                    '</div>';
            }
        }

        function removerCustoEmpresa(index) {
            custosNovaEmpresa.splice(index, 1);
            atualizarCustosNovaEmpresa();
        }

        function salvarEmpresa() {
            var nome = document.getElementById('nomeNovaEmpresa').value.trim();
            var impostoPercentual = parseFloat(document.getElementById('impostoEmpresa').value);
            
            if (!nome) {
                alert('Por favor, digite o nome da empresa!');
                return;
            }
            
            if (isNaN(impostoPercentual) || impostoPercentual < 0) {
                alert('Por favor, informe o percentual de imposto da empresa (pode ser 0 se n√£o houver impostos)!');
                return;
            }
            
            var novaEmpresa = {
                id: Date.now(),
                nome: nome,
                impostoPercentual: impostoPercentual,
                custosFixos: custosNovaEmpresa.slice()
            };
            
            empresas.push(novaEmpresa);
            salvarDados();
            
            document.getElementById('nomeNovaEmpresa').value = '';
            document.getElementById('impostoEmpresa').value = '';
            custosNovaEmpresa = [];
            atualizarCustosNovaEmpresa();
            atualizarListas();
            
            alert('Empresa "' + nome + '" salva com sucesso!');
        }

        function atualizarListaEmpresas() {
            var container = document.getElementById('listaEmpresas');
            container.innerHTML = '';
            
            for (var i = 0; i < empresas.length; i++) {
                var empresa = empresas[i];
                var custosTexto = '';
                
                // Mostrar imposto obrigat√≥rio
                var impostoTexto = 'Imposto: ' + (empresa.impostoPercentual || 0).toFixed(1) + '%';
                
                // Mostrar outros custos
                for (var j = 0; j < empresa.custosFixos.length; j++) {
                    var custo = empresa.custosFixos[j];
                    if (j > 0 || custosTexto) custosTexto += ', ';
                    custosTexto += custo.nome + ': ';
                    if (custo.tipo === 'fixo') custosTexto += 'R$ ';
                    custosTexto += custo.valor;
                    if (custo.tipo === 'porcentagem') custosTexto += '%';
                }
                
                if (!custosTexto) custosTexto = 'Nenhum custo adicional';
                
                container.innerHTML += 
                    '<div class="item-card">' +
                        '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                            '<div style="flex: 1;">' +
                                '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + empresa.nome + '</div>' +
                                '<div style="font-size: 0.875rem; color: #dc2626; font-weight: 600; margin-bottom: 0.25rem;">' + impostoTexto + '</div>' +
                                '<div style="font-size: 0.875rem; color: #6b7280;">' + custosTexto + '</div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 0.5rem; margin-left: 1rem;">' +
                                '<button onclick="editarEmpresa(' + empresa.id + ')" class="btn btn-blue" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">‚úèÔ∏è Editar</button>' +
                                '<button onclick="deletarEmpresa(' + empresa.id + ')" class="btn btn-red" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üóëÔ∏è Deletar</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }
        }

        // Marketplaces
        function adicionarCustoMarketplace() {
            custosNovoMarketplace.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarCustosNovoMarketplace();
        }

        function atualizarCustosNovoMarketplace() {
            var container = document.getElementById('custosNovoMarketplace');
            container.innerHTML = '';
            
            for (var i = 0; i < custosNovoMarketplace.length; i++) {
                var custo = custosNovoMarketplace[i];
                container.innerHTML += 
                    '<div class="input-row">' +
                        '<input type="text" value="' + custo.nome + '" onchange="custosNovoMarketplace[' + i + '].nome = this.value;" placeholder="Nome do custo" class="input-small" style="flex: 1;">' +
                        '<input type="number" step="0.01" value="' + custo.valor + '" onchange="custosNovoMarketplace[' + i + '].valor = this.value;" placeholder="Valor" class="input-small" style="width: 80px;">' +
                        '<select onchange="custosNovoMarketplace[' + i + '].tipo = this.value;" class="input-small" style="width: 80px;">' +
                            '<option value="fixo"' + (custo.tipo === 'fixo' ? ' selected' : '') + '>R$</option>' +
                            '<option value="porcentagem"' + (custo.tipo === 'porcentagem' ? ' selected' : '') + '>%</option>' +
                        '</select>' +
                        '<button onclick="removerCustoMarketplace(' + i + ')" style="color: #dc2626; background: none; border: none; cursor: pointer; padding: 4px;">üóëÔ∏è</button>' +
                    '</div>';
            }
        }

        function removerCustoMarketplace(index) {
            custosNovoMarketplace.splice(index, 1);
            atualizarCustosNovoMarketplace();
        }

        function salvarMarketplace() {
            var nome = document.getElementById('nomeNovoMarketplace').value.trim();
            var comissaoPercentual = parseFloat(document.getElementById('comissaoMarketplace').value);
            
            if (!nome) {
                alert('Por favor, digite o nome do marketplace!');
                return;
            }
            
            if (isNaN(comissaoPercentual) || comissaoPercentual < 0) {
                alert('Por favor, informe o percentual de comiss√£o do marketplace (pode ser 0 se n√£o houver comiss√£o)!');
                return;
            }
            
            var novoMarketplace = {
                id: Date.now(),
                nome: nome,
                comissaoPercentual: comissaoPercentual,
                custosFixos: custosNovoMarketplace.slice()
            };
            
            marketplaces.push(novoMarketplace);
            salvarDados();
            
            document.getElementById('nomeNovoMarketplace').value = '';
            document.getElementById('comissaoMarketplace').value = '';
            custosNovoMarketplace = [];
            atualizarCustosNovoMarketplace();
            atualizarListas();
            
            alert('Marketplace "' + nome + '" salvo com sucesso!');
        }

        function atualizarListaMarketplaces() {
            var container = document.getElementById('listaMarketplaces');
            container.innerHTML = '';
            
            for (var i = 0; i < marketplaces.length; i++) {
                var marketplace = marketplaces[i];
                var custosTexto = '';
                
                // Mostrar comiss√£o obrigat√≥ria
                var comissaoTexto = 'Comiss√£o: ' + (marketplace.comissaoPercentual || 0).toFixed(1) + '%';
                
                // Mostrar outros custos
                for (var j = 0; j < marketplace.custosFixos.length; j++) {
                    var custo = marketplace.custosFixos[j];
                    if (j > 0 || custosTexto) custosTexto += ', ';
                    custosTexto += custo.nome + ': ';
                    if (custo.tipo === 'fixo') custosTexto += 'R$ ';
                    custosTexto += custo.valor;
                    if (custo.tipo === 'porcentagem') custosTexto += '%';
                }
                
                if (!custosTexto) custosTexto = 'Nenhuma taxa adicional';
                
                container.innerHTML += 
                    '<div class="item-card">' +
                        '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                            '<div style="flex: 1;">' +
                                '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + marketplace.nome + '</div>' +
                                '<div style="font-size: 0.875rem; color: #16a34a; font-weight: 600; margin-bottom: 0.25rem;">' + comissaoTexto + '</div>' +
                                '<div style="font-size: 0.875rem; color: #6b7280;">' + custosTexto + '</div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 0.5rem; margin-left: 1rem;">' +
                                '<button onclick="editarMarketplace(' + marketplace.id + ')" class="btn btn-green" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">‚úèÔ∏è Editar</button>' +
                                '<button onclick="deletarMarketplace(' + marketplace.id + ')" class="btn btn-red" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üóëÔ∏è Deletar</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }
        }

        // Editar/Deletar Empresas
        function editarEmpresa(id) {
            var empresa = encontrarEmpresa(id);
            if (!empresa) return;
            
            document.getElementById('nomeNovaEmpresa').value = empresa.nome;
            document.getElementById('impostoEmpresa').value = empresa.impostoPercentual || 0;
            custosNovaEmpresa = empresa.custosFixos.slice();
            atualizarCustosNovaEmpresa();
            
            // Remove empresa da lista
            for (var i = 0; i < empresas.length; i++) {
                if (empresas[i].id === id) {
                    empresas.splice(i, 1);
                    break;
                }
            }
            salvarDados();
            atualizarListas();
            
            alert('Empresa carregada para edi√ß√£o! Fa√ßa as altera√ß√µes e clique em "Salvar Empresa".');
        }

        function deletarEmpresa(id) {
            var empresa = encontrarEmpresa(id);
            if (!empresa) return;
            
            if (confirm('Tem certeza que deseja deletar a empresa "' + empresa.nome + '"?')) {
                for (var i = 0; i < empresas.length; i++) {
                    if (empresas[i].id === id) {
                        empresas.splice(i, 1);
                        break;
                    }
                }
                salvarDados();
                atualizarListas();
                alert('Empresa deletada com sucesso!');
            }
        }

        // Editar/Deletar Marketplaces
        function editarMarketplace(id) {
            var marketplace = encontrarMarketplace(id);
            if (!marketplace) return;
            
            document.getElementById('nomeNovoMarketplace').value = marketplace.nome;
            document.getElementById('comissaoMarketplace').value = marketplace.comissaoPercentual || 0;
            custosNovoMarketplace = marketplace.custosFixos.slice();
            atualizarCustosNovoMarketplace();
            
            // Remove marketplace da lista
            for (var i = 0; i < marketplaces.length; i++) {
                if (marketplaces[i].id === id) {
                    marketplaces.splice(i, 1);
                    break;
                }
            }
            salvarDados();
            atualizarListas();
            
            alert('Marketplace carregado para edi√ß√£o! Fa√ßa as altera√ß√µes e clique em "Salvar Marketplace".');
        }

        function deletarMarketplace(id) {
            var marketplace = encontrarMarketplace(id);
            if (!marketplace) return;
            
            if (confirm('Tem certeza que deseja deletar o marketplace "' + marketplace.nome + '"?')) {
                for (var i = 0; i < marketplaces.length; i++) {
                    if (marketplaces[i].id === id) {
                        marketplaces.splice(i, 1);
                        break;
                    }
                }
                salvarDados();
                atualizarListas();
                alert('Marketplace deletado com sucesso!');
            }
        }

        // Backup/Restaura√ß√£o
        function exportarConfiguracoes() {
            var dados = {
                empresas: empresas,
                marketplaces: marketplaces,
                dataExport: new Date().toLocaleString('pt-BR')
            };
            
            var arquivo = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(arquivo);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'sisPre_backup_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importarConfiguracoes(event) {
            var arquivo = event.target.files[0];
            if (!arquivo) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados = JSON.parse(e.target.result);
                    if (dados.empresas && dados.marketplaces) {
                        empresas = dados.empresas;
                        marketplaces = dados.marketplaces;
                        salvarDados();
                        atualizarListas();
                        alert('Configura√ß√µes importadas com sucesso!');
                    } else {
                        alert('Arquivo inv√°lido!');
                    }
                } catch (error) {
                    alert('Erro ao importar arquivo!');
                }
            };
            reader.readAsText(arquivo);
            event.target.value = '';
        }

        function limparTodosDados() {
            if (confirm('Tem certeza que deseja apagar todas as configura√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('sisPre_empresas');
                localStorage.removeItem('sisPre_marketplaces');
                empresas = [];
                marketplaces = [];
                gastosAdicionais = [];
                custosNovaEmpresa = [];
                custosNovoMarketplace = [];
                
                // Limpar campos da interface
                document.getElementById('nomeNovaEmpresa').value = '';
                document.getElementById('impostoEmpresa').value = '';
                document.getElementById('nomeNovoMarketplace').value = '';
                document.getElementById('comissaoMarketplace').value = '';
                
                atualizarListas();
                atualizarGastosAdicionais();
                atualizarCustosNovaEmpresa();
                atualizarCustosNovoMarketplace();
                mostrarResultadoVazio();
                
                alert('Todas as configura√ß√µes foram apagadas!');
            }
        }

        // ========================================
        // FUN√á√ïES DO PROCESSAMENTO EM LOTE
        // ========================================

        // Atualizar selects da tela de lote
        function atualizarSelectsLote() {
            var selectEmpresa = document.getElementById('empresaLote');
            var selectMarketplace = document.getElementById('marketplaceLote');
            
            selectEmpresa.innerHTML = '<option value="">Selecione a empresa...</option>';
            selectMarketplace.innerHTML = '<option value="">Selecione o marketplace...</option>';
            
            for (var i = 0; i < empresas.length; i++) {
                selectEmpresa.innerHTML += '<option value="' + empresas[i].id + '">' + empresas[i].nome + '</option>';
            }
            
            for (var i = 0; i < marketplaces.length; i++) {
                selectMarketplace.innerHTML += '<option value="' + marketplaces[i].id + '">' + marketplaces[i].nome + '</option>';
            }
        }

        // Processar arquivo uploadado
        function processarArquivo(event) {
            var arquivo = event.target.files[0];
            if (!arquivo) return;

            // Mostrar progresso
            document.getElementById('progressoUpload').classList.remove('hidden');
            atualizarProgresso(10);
            atualizarIndicador(1, 'processando');

            var nomeArquivo = arquivo.name.toLowerCase();
            var isExcel = nomeArquivo.endsWith('.xlsx') || nomeArquivo.endsWith('.xls');
            var isCsv = nomeArquivo.endsWith('.csv');

            if (!isExcel && !isCsv) {
                alert('Formato de arquivo n√£o suportado. Use .xlsx, .xls ou .csv');
                resetarUpload();
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados;
                    
                    atualizarProgresso(30);

                    if (isExcel) {
                        dados = processarExcel(e.target.result);
                    } else {
                        dados = processarCsv(e.target.result);
                    }

                    atualizarProgresso(60);

                    if (dados && dados.length > 0) {
                        dadosOriginais = dados;
                        atualizarProgresso(80);
                        validarDados();
                        atualizarProgresso(100);
                        arquivoCarregado = true;
                        atualizarIndicador(1, 'sucesso');
                    } else {
                        throw new Error('Nenhum dado encontrado no arquivo');
                    }

                } catch (error) {
                    alert('Erro ao processar arquivo: ' + error.message);
                    resetarUpload();
                }
            };

            if (isExcel) {
                reader.readAsArrayBuffer(arquivo);
            } else {
                reader.readAsText(arquivo);
            }
        }

        // Processar arquivo Excel
        function processarExcel(arrayBuffer) {
            var workbook = XLSX.read(arrayBuffer, { type: 'array' });
            var primeiraPlanilha = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[primeiraPlanilha];
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Converter para formato padr√£o
            if (jsonData.length < 2) {
                throw new Error('Planilha deve ter pelo menos cabe√ßalho e uma linha de dados');
            }
            
            var cabecalho = jsonData[0];
            var dados = [];
            
            for (var i = 1; i < jsonData.length; i++) {
                var linha = {};
                for (var j = 0; j < cabecalho.length; j++) {
                    linha[cabecalho[j]] = jsonData[i][j];
                }
                dados.push(linha);
            }
            
            return dados;
        }

        // Processar arquivo CSV
        function processarCsv(csvText) {
            var resultado = Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimiter: ',',
                encoding: 'UTF-8'
            });

            return resultado.data;
        }

        // Validar dados carregados
        function validarDados() {
            if (dadosOriginais.length === 0) {
                mostrarErroValidacao('Nenhum dado encontrado no arquivo');
                return;
            }

            var amostra = dadosOriginais[0];
            var colunas = Object.keys(amostra);
            
            // Mapear colunas automaticamente
            colunasMapeadas = mapearColunas(colunas);
            
            // Verificar se encontrou as colunas obrigat√≥rias
            var colunasObrigatorias = ['codigo', 'nome', 'custo'];
            var colunasFaltando = [];
            var colunasEncontradas = [];
            
            for (var i = 0; i < colunasObrigatorias.length; i++) {
                var tipoColuna = colunasObrigatorias[i];
                if (colunasMapeadas[tipoColuna]) {
                    colunasEncontradas.push(tipoColuna + ': "' + colunasMapeadas[tipoColuna] + '"');
                } else {
                    colunasFaltando.push(tipoColuna);
                }
            }
            
            if (colunasFaltando.length > 0) {
                var mensagemErro = 'Colunas obrigat√≥rias n√£o encontradas: ' + colunasFaltando.join(', ');
                mensagemErro += '\n\nColunas dispon√≠veis no arquivo: ' + colunas.join(', ');
                mensagemErro += '\n\nColunas encontradas: ' + (colunasEncontradas.length > 0 ? colunasEncontradas.join(', ') : 'nenhuma');
                mostrarErroValidacao(mensagemErro);
                return;
            }
            
            // Validar se h√° dados v√°lidos
            var produtosValidos = 0;
            var errosEncontrados = [];
            
            for (var i = 0; i < Math.min(5, dadosOriginais.length); i++) {
                var linha = dadosOriginais[i];
                var codigo = linha[colunasMapeadas.codigo];
                var nome = linha[colunasMapeadas.nome];
                var custo = parseFloat(linha[colunasMapeadas.custo]);
                
                if (codigo && nome && !isNaN(custo) && custo > 0) {
                    produtosValidos++;
                } else {
                    if (!codigo) errosEncontrados.push('Linha ' + (i+2) + ': c√≥digo vazio');
                    if (!nome) errosEncontrados.push('Linha ' + (i+2) + ': nome vazio');
                    if (isNaN(custo) || custo <= 0) errosEncontrados.push('Linha ' + (i+2) + ': custo inv√°lido (' + linha[colunasMapeadas.custo] + ')');
                }
            }
            
            if (produtosValidos === 0) {
                var mensagemErro = 'Nenhum produto v√°lido encontrado nas primeiras linhas.\n\nProblemas detectados:\n' + errosEncontrados.slice(0, 5).join('\n');
                mostrarErroValidacao(mensagemErro);
                return;
            }
            
            // Valida√ß√£o bem-sucedida
            mostrarSucessoValidacao();
            mostrarPrevia();
        }

        // Mapear colunas automaticamente
        function mapearColunas(colunas) {
            var mapeamento = {};
            
            for (var i = 0; i < colunas.length; i++) {
                var colunaOriginal = colunas[i];
                if (!colunaOriginal) continue;
                
                var coluna = colunaOriginal.toString().toLowerCase().trim();
                
                // Mapear c√≥digo
                if (coluna.includes('codigo') || coluna.includes('c√≥digo') || 
                    coluna.includes('cod') || coluna.includes('sku') ||
                    coluna.includes('id') || coluna === 'codigo do produto' ||
                    coluna === 'c√≥digo do produto') {
                    mapeamento.codigo = colunaOriginal;
                }
                // Mapear nome
                else if (coluna.includes('nome') || coluna.includes('produto') || 
                         coluna.includes('descri') || coluna.includes('title') ||
                         coluna === 'nome do produto') {
                    mapeamento.nome = colunaOriginal;
                }
                // Mapear custo
                else if (coluna.includes('custo') || coluna.includes('preco') || 
                         coluna.includes('pre√ßo') || coluna.includes('valor') ||
                         coluna.includes('price') || coluna === 'custo do produto' ||
                         coluna.includes('cost')) {
                    mapeamento.custo = colunaOriginal;
                }
            }
            
            return mapeamento;
        }

        // Mostrar erro de valida√ß√£o
        function mostrarErroValidacao(mensagem) {
            atualizarIndicador(2, 'erro');
            document.getElementById('statusValidacao').classList.remove('hidden');
            
            // Quebrar mensagem em linhas para melhor formata√ß√£o
            var linhas = mensagem.split('\n');
            var htmlMensagem = '';
            
            for (var i = 0; i < linhas.length; i++) {
                if (linhas[i].trim()) {
                    htmlMensagem += '<p style="margin: 0.25rem 0;">' + linhas[i] + '</p>';
                }
            }
            
            document.getElementById('resultadoValidacao').innerHTML = 
                '<div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 6px; padding: 1rem;">' +
                    '<h4 style="color: #dc2626; font-weight: 600; margin: 0 0 0.5rem 0;">‚ùå Erro na Valida√ß√£o</h4>' +
                    '<div style="color: #dc2626; font-size: 0.875rem;">' + htmlMensagem + '</div>' +
                    '<div style="background: #fee2e2; margin-top: 1rem; padding: 0.75rem; border-radius: 4px;">' +
                        '<p style="color: #991b1b; font-size: 0.75rem; margin: 0; font-weight: 500;">üí° Dica:</p>' +
                        '<p style="color: #991b1b; font-size: 0.75rem; margin: 0.25rem 0 0 0;">Certifique-se de que sua planilha tenha colunas com nomes como: "C√≥digo", "Nome do Produto", "Custo" ou varia√ß√µes similares.</p>' +
                    '</div>' +
                '</div>';
        }

        // Mostrar sucesso na valida√ß√£o
        function mostrarSucessoValidacao() {
            atualizarIndicador(2, 'sucesso');
            document.getElementById('statusValidacao').classList.remove('hidden');
            
            var totalLinhas = dadosOriginais.length;
            var colunasDetectadas = [];
            
            if (colunasMapeadas.codigo) colunasDetectadas.push('C√≥digo: "' + colunasMapeadas.codigo + '"');
            if (colunasMapeadas.nome) colunasDetectadas.push('Nome: "' + colunasMapeadas.nome + '"');
            if (colunasMapeadas.custo) colunasDetectadas.push('Custo: "' + colunasMapeadas.custo + '"');
            
            // Validar alguns produtos para dar estat√≠sticas
            var produtosValidos = 0;
            var custoMinimo = Infinity;
            var custoMaximo = 0;
            
            for (var i = 0; i < dadosOriginais.length; i++) {
                var linha = dadosOriginais[i];
                var custo = parseFloat(linha[colunasMapeadas.custo]);
                
                if (!isNaN(custo) && custo > 0) {
                    produtosValidos++;
                    if (custo < custoMinimo) custoMinimo = custo;
                    if (custo > custoMaximo) custoMaximo = custo;
                }
            }
            
            document.getElementById('resultadoValidacao').innerHTML = 
                '<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 1rem;">' +
                    '<h4 style="color: #16a34a; font-weight: 600; margin: 0 0 0.5rem 0;">‚úÖ Valida√ß√£o Bem-sucedida</h4>' +
                    '<div style="color: #16a34a; margin-bottom: 0.75rem;">' +
                        '<p style="margin: 0 0 0.25rem 0;"><strong>' + totalLinhas + ' produtos</strong> carregados com sucesso!</p>' +
                        '<p style="margin: 0;"><strong>' + produtosValidos + ' produtos v√°lidos</strong> (com custo > 0)</p>' +
                    '</div>' +
                    '<div style="background: #dcfce7; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.75rem;">' +
                        '<p style="color: #166534; font-size: 0.875rem; margin: 0 0 0.25rem 0;"><strong>üìä Estat√≠sticas dos Custos:</strong></p>' +
                        '<p style="color: #166534; font-size: 0.875rem; margin: 0;">Menor: R$ ' + (custoMinimo === Infinity ? '0,00' : custoMinimo.toFixed(2)) + ' | Maior: R$ ' + custoMaximo.toFixed(2) + '</p>' +
                    '</div>' +
                    '<p style="color: #6b7280; font-size: 0.875rem; margin: 0;"><strong>Colunas mapeadas:</strong> ' + colunasDetectadas.join(' ‚Ä¢ ') + '</p>' +
                '</div>';
        }

        // Mostrar pr√©via dos dados
        function mostrarPrevia() {
            atualizarIndicador(3, 'sucesso');
            document.getElementById('statusPrevia').classList.remove('hidden');
            
            var html = '<div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 6px;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
            
            // Cabe√ßalho
            html += '<thead style="background: #f9fafb;">';
            html += '<tr>';
            html += '<th style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: left;">C√≥digo</th>';
            html += '<th style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: left;">Nome do Produto</th>';
            html += '<th style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: right;">Custo (R$)</th>';
            html += '</tr>';
            html += '</thead>';
            
            // Dados (primeiras 5 linhas)
            html += '<tbody>';
            var limite = Math.min(5, dadosOriginais.length);
            for (var i = 0; i < limite; i++) {
                var linha = dadosOriginais[i];
                html += '<tr style="border-bottom: 1px solid #f3f4f6;">';
                html += '<td style="padding: 0.75rem;">' + (linha[colunasMapeadas.codigo] || '-') + '</td>';
                html += '<td style="padding: 0.75rem;">' + (linha[colunasMapeadas.nome] || '-') + '</td>';
                html += '<td style="padding: 0.75rem; text-align: right;">R$ ' + (parseFloat(linha[colunasMapeadas.custo]) || 0).toFixed(2) + '</td>';
                html += '</tr>';
            }
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            if (dadosOriginais.length > 5) {
                html += '<p style="text-align: center; color: #6b7280; font-size: 0.875rem; margin: 0.5rem 0 0 0;">... e mais ' + (dadosOriginais.length - 5) + ' produtos</p>';
            }
            
            document.getElementById('tabelaPrevia').innerHTML = html;
            
            // Mostrar se√ß√£o de configura√ß√£o
            document.getElementById('statusConfiguracao').classList.remove('hidden');
            atualizarIndicador(4, 'aguardando');
            verificarConfiguracao();
        }

        // Verificar se pode processar
        function verificarConfiguracao() {
            var empresa = document.getElementById('empresaLote').value;
            var marketplace = document.getElementById('marketplaceLote').value;
            var margem = document.getElementById('margemLote').value;
            
            var podeProcessar = empresa && marketplace && margem && parseFloat(margem) > 0;
            document.getElementById('btnProcessarLote').disabled = !podeProcessar;
            
            if (podeProcessar) {
                atualizarIndicador(4, 'pronto');
            }
        }

        // Atualizar indicador de etapa
        function atualizarIndicador(etapa, status) {
            var indicador = document.getElementById('indicadorEtapa' + etapa);
            if (!indicador) return;
            
            indicador.className = 'w-4 h-4 rounded-full';
            
            switch (status) {
                case 'processando':
                    indicador.className += ' bg-blue-500 animate-pulse';
                    break;
                case 'sucesso':
                    indicador.className += ' bg-green-500';
                    break;
                case 'erro':
                    indicador.className += ' bg-red-500';
                    break;
                case 'pronto':
                    indicador.className += ' bg-yellow-500';
                    break;
                case 'aguardando':
                    indicador.className += ' bg-yellow-300';
                    break;
                default:
                    indicador.className += ' bg-gray-300';
            }
        }

        // Atualizar barra de progresso
        function atualizarProgresso(porcentagem) {
            document.getElementById('barraProgresso').style.width = porcentagem + '%';
        }

        // Resetar upload
        function resetarUpload() {
            document.getElementById('progressoUpload').classList.add('hidden');
            document.getElementById('inputArquivo').value = '';
            atualizarProgresso(0);
            atualizarIndicador(1, 'aguardando');
        }

        // Resetar todo o processamento
        function resetarProcessamento() {
            // Resetar dados
            dadosOriginais = [];
            colunasMapeadas = {};
            arquivoCarregado = false;
            
            // Esconder se√ß√µes
            document.getElementById('statusValidacao').classList.add('hidden');
            document.getElementById('statusPrevia').classList.add('hidden');
            document.getElementById('statusConfiguracao').classList.add('hidden');
            document.getElementById('statusResultados').classList.add('hidden');
            
            // Resetar indicadores
            for (var i = 1; i <= 5; i++) {
                atualizarIndicador(i, 'aguardando');
            }
            
            // Resetar upload
            resetarUpload();
            
            // Limpar formul√°rio
            document.getElementById('empresaLote').value = '';
            document.getElementById('marketplaceLote').value = '';
            document.getElementById('margemLote').value = '';
            document.getElementById('tipoMargemLote').value = 'venda';
            document.getElementById('descontoLote').value = '0';
            document.getElementById('coParticipacaoLote').value = '0';
            document.getElementById('freteLote').value = '0';
            document.getElementById('freteComissaoLote').value = '0';
        }

                    // Fun√ß√£o placeholder para exporta√ß√£o (em desenvolvimento)
        function exportarResultados() {
            alert('Fun√ß√£o de exporta√ß√£o em desenvolvimento!');
        }

        // *** FUN√á√ÉO DE C√ÅLCULO INDIVIDUAL PARA LOTE ***
        function calcularProdutoIndividual(custoBase, configuracao) {
            // Usar a mesma l√≥gica iterativa do c√°lculo principal
            var configCompleta = {
                custo: parseFloat(custoBase),
                margem: parseFloat(configuracao.margem),
                tipoMargem: configuracao.tipoMargem,
                empresaId: configuracao.empresaId,
                marketplaceId: configuracao.marketplaceId,
                descontoMarketplace: parseFloat(configuracao.desconto) || 0,
                coParticipacaoVendedor: parseFloat(configuracao.coParticipacao) || 0,
                freteParaImposto: parseFloat(configuracao.frete) || 0,
                freteParaComissao: parseFloat(configuracao.freteComissao) || 0
            };
            
            if (configCompleta.custo <= 0 || configCompleta.margem <= 0) {
                return null;
            }
            
            // Usar c√°lculo iterativo para garantir margem exata
            var resultado = calcularPrecoIterativo(configCompleta);
            
            if (!resultado) return null;
            
            return {
                custoBase: resultado.custoBase,
                gastosFixosTotal: resultado.gastosFixosTotal,
                gastosPercentuaisTotal: resultado.gastosPercentuaisTotal,
                precoVendaSemDesconto: resultado.precoVendaSemDesconto,
                precoFinalComprador: resultado.precoFinalComprador,
                lucroLiquidoVendedor: resultado.lucroLiquido,
                margemSobreVenda: resultado.margemReal,
                margemSobreCusto: resultado.tipoMargem === 'custo' ? resultado.margemReal : (resultado.lucroLiquido / resultado.custoBase) * 100,
                valorDescontoVendedor: resultado.valorDescontoVendedor,
                gastosDetalhados: resultado.gastosDetalhados
            };
        }

        // Mostrar tabela simples de resultados
        function mostrarTabelaSimples(resultados) {
            // Mostrar se√ß√£o de resultados
            document.getElementById('statusResultados').classList.remove('hidden');
            
            // Criar HTML da tabela (concatena√ß√£o simples, n√£o template literals)
            var html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            
            // Cabe√ßalho
            html += '<thead>';
            html += '<tr style="background: #f9fafb;">';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">C√≥digo</th>';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Nome</th>';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Custo Base</th>';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Pre√ßo Marketplace</th>';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Lucro</th>';
            html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Margem %</th>';
            html += '</tr>';
            html += '</thead>';
            
            // Dados
            html += '<tbody>';
            for (var i = 0; i < resultados.length; i++) {
                var r = resultados[i];
                html += '<tr>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">' + r.codigo + '</td>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">' + r.nome + '</td>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">R$ ' + r.custoBase.toFixed(2) + '</td>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">R$ ' + r.precoVendaSemDesconto.toFixed(2) + '</td>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">R$ ' + r.lucroLiquidoVendedor.toFixed(2) + '</td>';
                html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;">' + r.margemSobreVenda.toFixed(1) + '%</td>';
                html += '</tr>';
            }
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            // Informa√ß√£o simples do lote
            html += '<div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0;">';
            html += '<p style="color: #15803d; margin: 0; font-weight: 600;">‚úÖ <strong>Processamento em lote conclu√≠do com sucesso!</strong></p>';
            html += '</div>';
            
            // Estat√≠sticas gerais
            html += '<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-top: 1rem;">';
            html += '<h4 style="font-weight: 600; margin: 0 0 0.5rem 0; color: #475569;">üìà Resumo Geral</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">';
            
            // Calcular estat√≠sticas
            var totalProdutos = resultados.length;
            var margemMedia = 0;
            var lucroTotal = 0;
            
            for (var i = 0; i < resultados.length; i++) {
                margemMedia += resultados[i].margemSobreVenda;
                lucroTotal += resultados[i].lucroLiquidoVendedor;
            }
            margemMedia = margemMedia / totalProdutos;
            
            html += '<div>Total de Produtos: <strong>' + totalProdutos + '</strong></div>';
            html += '<div>Margem M√©dia: <strong>' + margemMedia.toFixed(1) + '%</strong></div>';
            html += '<div>Lucro Total: <strong>R$ ' + lucroTotal.toFixed(2) + '</strong></div>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('tabelaResultados').innerHTML = html;
        }

        // Processar todos os produtos em lote
        function processarLote() {
            // 1. Capturar configura√ß√£o do formul√°rio
            var config = {
                empresaId: document.getElementById('empresaLote').value,
                marketplaceId: document.getElementById('marketplaceLote').value,
                margem: parseFloat(document.getElementById('margemLote').value),
                tipoMargem: document.getElementById('tipoMargemLote').value,
                desconto: parseFloat(document.getElementById('descontoLote').value) || 0,
                coParticipacao: parseFloat(document.getElementById('coParticipacaoLote').value) || 0,
                frete: parseFloat(document.getElementById('freteLote').value) || 0,
                freteComissao: parseFloat(document.getElementById('freteComissaoLote').value) || 0
            };
            
            // 2. Validar configura√ß√£o
            if (!config.empresaId || !config.marketplaceId || !config.margem || config.margem <= 0) {
                alert('Preencha todos os campos obrigat√≥rios (Empresa, Marketplace e Margem)');
                return;
            }
            
            if (!dadosOriginais || dadosOriginais.length === 0) {
                alert('Nenhum dado carregado. Fa√ßa o upload de uma planilha primeiro.');
                return;
            }
            
            // 3. Processar cada produto
            var resultados = [];
            var produtosProcessados = 0;
            var produtosComErro = 0;
            
            for (var i = 0; i < dadosOriginais.length; i++) {
                var produto = dadosOriginais[i];
                var codigo = produto[colunasMapeadas.codigo];
                var nome = produto[colunasMapeadas.nome];
                var custo = parseFloat(produto[colunasMapeadas.custo]);
                
                // Verificar se produto tem dados v√°lidos
                if (codigo && nome && !isNaN(custo) && custo > 0) {
                    // Calcular pre√ßos usando a fun√ß√£o individual corrigida
                    var resultado = calcularProdutoIndividual(custo, config);
                    
                    if (resultado) {
                        // Adicionar informa√ß√µes do produto
                        resultado.codigo = codigo;
                        resultado.nome = nome;
                        resultados.push(resultado);
                        produtosProcessados++;
                    } else {
                        produtosComErro++;
                    }
                } else {
                    produtosComErro++;
                }
            }
            
            // 4. Mostrar resultados
            if (resultados.length > 0) {
                mostrarTabelaSimples(resultados);
                
                // Mostrar estat√≠sticas
                var mensagem = 'Processamento conclu√≠do!\n\n';
                mensagem += '‚úÖ Produtos processados: ' + produtosProcessados + '\n';
                if (produtosComErro > 0) {
                    mensagem += '‚ö†Ô∏è Produtos com erro: ' + produtosComErro + '\n';
                }
                mensagem += 'üìä Total de resultados: ' + resultados.length + '\n\n';
                mensagem += 'Processamento conclu√≠do com sucesso!';
                
                alert(mensagem);
            } else {
                alert('Nenhum produto p√¥de ser processado. Verifique os dados da planilha.');
            }
        }

        // Adicionar eventos para verificar configura√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (document.getElementById('empresaLote')) {
                    document.getElementById('empresaLote').onchange = verificarConfiguracao;
                    document.getElementById('marketplaceLote').onchange = verificarConfiguracao;
                    document.getElementById('margemLote').oninput = verificarConfiguracao;
                    
                    // Configurar drag and drop
                    var areaUpload = document.getElementById('areaUpload');
                    if (areaUpload) {
                        areaUpload.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        });
                        
                        areaUpload.addEventListener('dragleave', function(e) {
                            e.preventDefault();
                            this.classList.remove('drag-over');
                        });
                        
                        areaUpload.addEventListener('drop', function(e) {
                            e.preventDefault();
                            this.classList.remove('drag-over');
                            
                            var files = e.dataTransfer.files;
                            if (files.length > 0) {
                                document.getElementById('inputArquivo').files = files;
                                processarArquivo({ target: { files: files } });
                            }
                        });
                    }
                }
            }, 100);
        });
    </script>
    

    <script>
// ================================================================================
// JAVASCRIPT INLINE - AN√ÅLISE REVERSA INTEGRADO
// ================================================================================
// ================================================================================
// SISPRE v2.0 - M√ìDULO DE AN√ÅLISE REVERSA
// ================================================================================
// Este arquivo cont√©m a nova funcionalidade de An√°lise Reversa
// que permite simular cen√°rios a partir de um pre√ßo de venda j√° definido
// ================================================================================

// Armazenamento de cen√°rios
var cenarios = [];
var cenarioAtual = null;

// Inicializar an√°lise
function inicializarAnalise() {
    cenarios = [{
        id: 1,
        nome: "Situa√ß√£o Atual",
        precoVenda: 0,
        custo: 0,
        descontoMarketplace: 0,
        coParticipacao: 0,
        gastosExtras: [],
        resultado: null,
        empresaId: null,
        marketplaceId: null,
        freteParaImposto: 0,
        freteParaComissao: 0
    }];
    
    atualizarListaCenarios();
}

// Adicionar novo cen√°rio
function adicionarCenario() {
    var ultimoCenario = cenarios[cenarios.length - 1];
    var novoCenario = {
        id: Date.now(),
        nome: "Cen√°rio " + (cenarios.length + 1),
        precoVenda: ultimoCenario.precoVenda,
        custo: ultimoCenario.custo,
        descontoMarketplace: 0,
        coParticipacao: 0,
        gastosExtras: [],
        resultado: null,
        empresaId: ultimoCenario.empresaId,
        marketplaceId: ultimoCenario.marketplaceId,
        freteParaImposto: ultimoCenario.freteParaImposto,
        freteParaComissao: ultimoCenario.freteParaComissao
    };
    
    cenarios.push(novoCenario);
    atualizarListaCenarios();
}

// Duplicar cen√°rio
function duplicarCenario(id) {
    var cenario = encontrarCenario(id);
    if (!cenario) return;
    
    var novoCenario = JSON.parse(JSON.stringify(cenario));
    novoCenario.id = Date.now();
    novoCenario.nome = cenario.nome + " (C√≥pia)";
    
    cenarios.push(novoCenario);
    atualizarListaCenarios();
}

// Remover cen√°rio
function removerCenario(id) {
    if (cenarios.length <= 1) {
        alert("Voc√™ precisa manter pelo menos um cen√°rio!");
        return;
    }
    
    if (!confirm("Tem certeza que deseja remover este cen√°rio?")) return;
    
    for (var i = 0; i < cenarios.length; i++) {
        if (cenarios[i].id === id) {
            cenarios.splice(i, 1);
            break;
        }
    }
    
    atualizarListaCenarios();
}

// Encontrar cen√°rio por ID
function encontrarCenario(id) {
    for (var i = 0; i < cenarios.length; i++) {
        if (cenarios[i].id == id) return cenarios[i];
    }
    return null;
}

// Calcular cen√°rio (an√°lise reversa)
function calcularCenarioReverso(cenario) {
    if (!cenario.precoVenda || cenario.precoVenda <= 0) return null;
    if (!cenario.custo || cenario.custo <= 0) return null;
    if (!cenario.empresaId || !cenario.marketplaceId) return null;
    
    var precoVenda = parseFloat(cenario.precoVenda);
    var custo = parseFloat(cenario.custo);
    var descontoMarketplace = parseFloat(cenario.descontoMarketplace) || 0;
    var coParticipacao = parseFloat(cenario.coParticipacao) || 0;
    var freteImposto = parseFloat(cenario.freteParaImposto) || 0;
    var freteComissao = parseFloat(cenario.freteParaComissao) || 0;
    
    // Calcular pre√ßo final que cliente paga
    var valorDescontoTotal = precoVenda * (descontoMarketplace / 100);
    var precoFinalCliente = precoVenda - valorDescontoTotal;
    
    // Calcular co-participa√ß√£o do vendedor
    var valorCoParticipacao = precoFinalCliente * (coParticipacao / 100);
    
    // Buscar empresa e marketplace
    var empresa = encontrarEmpresa(cenario.empresaId);
    var marketplace = encontrarMarketplace(cenario.marketplaceId);
    
    if (!empresa || !marketplace) return null;
    
    // Calcular custos
    var impostoPercentual = empresa.impostoPercentual || 0;
    var comissaoPercentual = marketplace.comissaoPercentual || 0;
    
    var gastosDetalhados = [];
    var totalCustos = custo;
    
    // Impostos sobre produto
    var impostoSobreProduto = (precoFinalCliente * impostoPercentual) / 100;
    totalCustos += impostoSobreProduto;
    gastosDetalhados.push({
        nome: 'Impostos sobre Produto (' + impostoPercentual.toFixed(1) + '%)',
        valor: impostoSobreProduto,
        categoria: 'empresa'
    });
    
    // Comiss√£o sobre produto
    var comissaoSobreProduto = (precoFinalCliente * comissaoPercentual) / 100;
    totalCustos += comissaoSobreProduto;
    gastosDetalhados.push({
        nome: 'Comiss√£o sobre Produto (' + comissaoPercentual.toFixed(1) + '%)',
        valor: comissaoSobreProduto,
        categoria: 'marketplace'
    });
    
    // Custos da empresa
    for (var i = 0; i < empresa.custosFixos.length; i++) {
        var custoEmp = empresa.custosFixos[i];
        var valorCusto = parseFloat(custoEmp.valor) || 0;
        var valorCalculado = 0;
        
        if (custoEmp.tipo === 'fixo') {
            valorCalculado = valorCusto;
        } else {
            var baseCalculo = precoFinalCliente + freteImposto;
            valorCalculado = (baseCalculo * valorCusto) / 100;
        }
        
        totalCustos += valorCalculado;
        gastosDetalhados.push({
            nome: custoEmp.nome + ' (Empresa)',
            valor: valorCalculado,
            categoria: 'empresa'
        });
    }
    
    // Custos do marketplace
    for (var i = 0; i < marketplace.custosFixos.length; i++) {
        var custoMkt = marketplace.custosFixos[i];
        var valorCusto = parseFloat(custoMkt.valor) || 0;
        var valorCalculado = 0;
        
        if (custoMkt.tipo === 'fixo') {
            valorCalculado = valorCusto;
        } else {
            var baseCalculo = precoFinalCliente + freteComissao;
            valorCalculado = (baseCalculo * valorCusto) / 100;
        }
        
        totalCustos += valorCalculado;
        gastosDetalhados.push({
            nome: custoMkt.nome + ' (Marketplace)',
            valor: valorCalculado,
            categoria: 'marketplace'
        });
    }
    
    // Impostos e comiss√µes sobre frete
    if (freteImposto > 0 && impostoPercentual > 0) {
        var impostoFrete = (freteImposto * impostoPercentual) / 100;
        totalCustos += impostoFrete;
        gastosDetalhados.push({
            nome: 'Impostos sobre Frete',
            valor: impostoFrete,
            categoria: 'frete'
        });
    }
    
    if (freteComissao > 0 && comissaoPercentual > 0) {
        var comissaoFrete = (freteComissao * comissaoPercentual) / 100;
        totalCustos += comissaoFrete;
        gastosDetalhados.push({
            nome: 'Comiss√£o sobre Frete',
            valor: comissaoFrete,
            categoria: 'frete'
        });
    }
    
    // Gastos extras do cen√°rio
    for (var i = 0; i < cenario.gastosExtras.length; i++) {
        var gasto = cenario.gastosExtras[i];
        var valorGasto = parseFloat(gasto.valor) || 0;
        var valorCalculado = 0;
        
        if (gasto.tipo === 'fixo') {
            valorCalculado = valorGasto;
        } else {
            valorCalculado = (precoFinalCliente * valorGasto) / 100;
        }
        
        totalCustos += valorCalculado;
        gastosDetalhados.push({
            nome: gasto.nome + ' (Extra)',
            valor: valorCalculado,
            categoria: 'extra'
        });
    }
    
    // Adicionar co-participa√ß√£o como custo
    if (valorCoParticipacao > 0) {
        totalCustos += valorCoParticipacao;
        gastosDetalhados.push({
            nome: 'Co-participa√ß√£o em Desconto (' + coParticipacao.toFixed(1) + '%)',
            valor: valorCoParticipacao,
            categoria: 'desconto'
        });
    }
    
    // Calcular lucro e margens
    var lucroLiquido = precoFinalCliente - totalCustos;
    var margemSobreVenda = (lucroLiquido / precoFinalCliente) * 100;
    var margemSobreCusto = (lucroLiquido / custo) * 100;
    
    // Determinar alerta
    var alerta = gerarAlerta(margemSobreVenda, lucroLiquido);
    
    return {
        precoVenda: precoVenda,
        precoFinalCliente: precoFinalCliente,
        valorDescontoTotal: valorDescontoTotal,
        valorCoParticipacao: valorCoParticipacao,
        custo: custo,
        totalCustos: totalCustos,
        lucroLiquido: lucroLiquido,
        margemSobreVenda: margemSobreVenda,
        margemSobreCusto: margemSobreCusto,
        gastosDetalhados: gastosDetalhados,
        alerta: alerta
    };
}

// Gerar alerta baseado na margem
function gerarAlerta(margem, lucro) {
    if (lucro < 0) {
        return {
            tipo: 'critico',
            icone: '‚ùå',
            titulo: 'PREJU√çZO!',
            mensagem: 'Voc√™ ter√° preju√≠zo de R$ ' + Math.abs(lucro).toFixed(2) + ' nesta venda',
            cor: '#dc2626'
        };
    } else if (margem < 0) {
        return {
            tipo: 'critico',
            icone: '‚ùå',
            titulo: 'PREJU√çZO',
            mensagem: 'Margem negativa! Voc√™ perder√° dinheiro nesta venda',
            cor: '#dc2626'
        };
    } else if (margem < 3) {
        return {
            tipo: 'ruim',
            icone: '‚ùå',
            titulo: 'MARGEM MUITO BAIXA',
            mensagem: 'Margem abaixo de 3%. Alto risco de preju√≠zo',
            cor: '#dc2626'
        };
    } else if (margem < 7) {
        return {
            tipo: 'atencao',
            icone: '‚ö†Ô∏è',
            titulo: 'ATEN√á√ÉO',
            mensagem: 'Margem baixa. Avalie se vale a pena',
            cor: '#f59e0b'
        };
    } else if (margem < 10) {
        return {
            tipo: 'medio',
            icone: '‚ö†Ô∏è',
            titulo: 'MARGEM ACEIT√ÅVEL',
            mensagem: 'Margem moderada, mas abaixo do ideal',
            cor: '#eab308'
        };
    } else {
        return {
            tipo: 'bom',
            icone: '‚úì',
            titulo: 'MARGEM SAUD√ÅVEL',
            mensagem: 'Boa margem para participar',
            cor: '#16a34a'
        };
    }
}

// Atualizar lista de cen√°rios na interface
function atualizarListaCenarios() {
    var container = document.getElementById('listaCenarios');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (var i = 0; i < cenarios.length; i++) {
        var cenario = cenarios[i];
        var resultado = cenario.resultado;
        
        var html = '<div class="cenario-card" id="cenario-' + cenario.id + '">';
        html += '<div class="cenario-header">';
        html += '<input type="text" value="' + cenario.nome + '" onchange="atualizarNomeCenario(' + cenario.id + ', this.value)" class="input-nome-cenario">';
        html += '<div class="cenario-acoes">';
        html += '<button onclick="duplicarCenario(' + cenario.id + ')" class="btn btn-sm btn-gray">üìã Duplicar</button>';
        if (cenarios.length > 1) {
            html += '<button onclick="removerCenario(' + cenario.id + ')" class="btn btn-sm btn-red">üóëÔ∏è Remover</button>';
        }
        html += '</div>';
        html += '</div>';
        
        // Formul√°rio do cen√°rio
        html += '<div class="cenario-form">';
        html += '<div class="form-row">';
        html += '<div class="form-group">';
        html += '<label>Desconto Marketplace (%)</label>';
        var onchangeDesconto = 'atualizarCenario(' + cenario.id + ', "descontoMarketplace", this.value)' + (cenario.id === 1 ? '; calcularSituacaoAtualAutomatica()' : '');
        html += '<input type="number" step="0.01" value="' + cenario.descontoMarketplace + '" onchange="' + onchangeDesconto + '" oninput="' + (cenario.id === 1 ? 'calcularSituacaoAtualAutomatica()' : '') + '" class="input-small">';
        html += '</div>';
        html += '<div class="form-group">';
        html += '<label>Co-participa√ß√£o (%)</label>';
        var onchangeCopartic = 'atualizarCenario(' + cenario.id + ', "coParticipacao", this.value)' + (cenario.id === 1 ? '; calcularSituacaoAtualAutomatica()' : '');
        html += '<input type="number" step="0.01" value="' + cenario.coParticipacao + '" onchange="' + onchangeCopartic + '" oninput="' + (cenario.id === 1 ? 'calcularSituacaoAtualAutomatica()' : '') + '" class="input-small">';
        html += '</div>';
        html += '</div>';
        // Bot√£o Calcular - esconder para Situa√ß√£o Atual (ID 1)
        if (cenario.id !== 1) {
            html += '<button onclick="calcularCenario(' + cenario.id + ')" class="btn btn-blue" style="width: 100%; margin-top: 0.5rem;">üßÆ Calcular Cen√°rio</button>';
        } else {
            html += '<p style="text-align: center; color: #718096; font-size: 0.875rem; margin-top: 0.5rem; font-style: italic;">üìä Resultado calculado automaticamente</p>';
        }
        html += '</div>';
        
        // Resultado
        if (resultado) {
            var alerta = resultado.alerta;
            html += '<div class="cenario-resultado" style="border-left: 4px solid ' + alerta.cor + ';">';
            html += '<div class="alerta-header" style="background: ' + alerta.cor + '20; color: ' + alerta.cor + ';">';
            html += '<span style="font-size: 1.5rem;">' + alerta.icone + '</span>';
            html += '<strong>' + alerta.titulo + '</strong>';
            html += '</div>';
            html += '<div class="resultado-resumo">';
            html += '<div>Cliente Paga: <strong>R$ ' + resultado.precoFinalCliente.toFixed(2) + '</strong></div>';
            html += '<div>Lucro: <strong style="color: ' + (resultado.lucroLiquido >= 0 ? '#16a34a' : '#dc2626') + ';">R$ ' + resultado.lucroLiquido.toFixed(2) + '</strong></div>';
            html += '<div>Margem: <strong>' + resultado.margemSobreVenda.toFixed(2) + '%</strong></div>';
            html += '</div>';
            html += '<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: ' + alerta.cor + ';"><strong>' + alerta.mensagem + '</strong></p>';
            html += '<button onclick="verDetalhamentoCenario(' + cenario.id + ')" class="btn btn-sm btn-gray" style="width: 100%; margin-top: 0.5rem;">üëÅÔ∏è Ver Detalhamento Completo</button>';
            html += '</div>';
        }
        
        html += '</div>';
        
        container.innerHTML += html;
    }
}

// Atualizar nome do cen√°rio
function atualizarNomeCenario(id, nome) {
    var cenario = encontrarCenario(id);
    if (cenario) {
        cenario.nome = nome;
    }
}

// Atualizar campo do cen√°rio
function atualizarCenario(id, campo, valor) {
    var cenario = encontrarCenario(id);
    if (cenario) {
        cenario[campo] = parseFloat(valor) || 0;
    }
}

// Calcular um cen√°rio espec√≠fico
function calcularCenario(id) {
    var cenario = encontrarCenario(id);
    if (!cenario) return;
    
    var resultado = calcularCenarioReverso(cenario);
    if (resultado) {
        cenario.resultado = resultado;
        atualizarListaCenarios();
        atualizarComparacao();
    } else {
        alert('Preencha todos os campos obrigat√≥rios (Pre√ßo de Venda, Custo, Empresa e Marketplace)');
    }
}

// Calcular todos os cen√°rios
function calcularTodosCenarios() {
    var calculados = 0;
    
    for (var i = 0; i < cenarios.length; i++) {
        var cenario = cenarios[i];
        var resultado = calcularCenarioReverso(cenario);
        if (resultado) {
            cenario.resultado = resultado;
            calculados++;
        }
    }
    
    if (calculados > 0) {
        atualizarListaCenarios();
        atualizarComparacao();
        alert('‚úÖ ' + calculados + ' cen√°rio(s) calculado(s) com sucesso!');
    } else {
        alert('‚ö†Ô∏è Nenhum cen√°rio p√¥de ser calculado. Verifique se todos os campos est√£o preenchidos.');
    }
}

// Atualizar compara√ß√£o entre cen√°rios
function atualizarComparacao() {
    var container = document.getElementById('tabelaComparacao');
    if (!container) return;
    
    // Filtrar apenas cen√°rios com resultado
    var cenariosComResultado = [];
    for (var i = 0; i < cenarios.length; i++) {
        if (cenarios[i].resultado) {
            cenariosComResultado.push(cenarios[i]);
        }
    }
    
    if (cenariosComResultado.length === 0) {
        container.innerHTML = '<div class="text-center text-gray" style="padding: 2rem;">Calcule os cen√°rios para ver a compara√ß√£o</div>';
        return;
    }
    
    var html = '<div style="overflow-x: auto;">';
    html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
    
    // Cabe√ßalho
    html += '<thead style="background: #f9fafb;">';
    html += '<tr>';
    html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: left;">Cen√°rio</th>';
    html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right;">Cliente Paga</th>';
    html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right;">Lucro</th>';
    html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right;">Margem %</th>';
    html += '<th style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;">Status</th>';
    html += '</tr>';
    html += '</thead>';
    
    // Dados
    html += '<tbody>';
    for (var i = 0; i < cenariosComResultado.length; i++) {
        var cenario = cenariosComResultado[i];
        var resultado = cenario.resultado;
        var alerta = resultado.alerta;
        
        html += '<tr>';
        html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb;"><strong>' + cenario.nome + '</strong></td>';
        html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right;">R$ ' + resultado.precoFinalCliente.toFixed(2) + '</td>';
        html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right; color: ' + (resultado.lucroLiquido >= 0 ? '#16a34a' : '#dc2626') + ';"><strong>R$ ' + resultado.lucroLiquido.toFixed(2) + '</strong></td>';
        html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: right;"><strong>' + resultado.margemSobreVenda.toFixed(1) + '%</strong></td>';
        html += '<td style="padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center;"><span style="background: ' + alerta.cor + '20; color: ' + alerta.cor + '; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">' + alerta.icone + ' ' + alerta.tipo.toUpperCase() + '</span></td>';
        html += '</tr>';
    }
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    container.innerHTML = html;
}

// Ver detalhamento de um cen√°rio
function verDetalhamentoCenario(id) {
    var cenario = encontrarCenario(id);
    if (!cenario || !cenario.resultado) return;
    
    var resultado = cenario.resultado;
    var alerta = resultado.alerta;
    
    var html = '<div style="max-width: 800px; margin: 0 auto;">';
    html += '<h3 style="margin-bottom: 1rem;">üìä Detalhamento: ' + cenario.nome + '</h3>';
    
    // Status
    html += '<div class="alerta-header" style="background: ' + alerta.cor + '20; color: ' + alerta.cor + '; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ' + alerta.cor + ';">';
    html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
    html += '<span style="font-size: 2rem;">' + alerta.icone + '</span>';
    html += '<div>';
    html += '<div style="font-weight: 700; font-size: 1.125rem;">' + alerta.titulo + '</div>';
    html += '<div style="font-size: 0.875rem;">' + alerta.mensagem + '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Valores principais
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">';
    html += '<div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">';
    html += '<div style="color: #6b7280; font-size: 0.875rem;">Pre√ßo de Venda</div>';
    html += '<div style="font-size: 1.5rem; font-weight: 700;">R$ ' + resultado.precoVenda.toFixed(2) + '</div>';
    if (resultado.valorDescontoTotal > 0) {
        html += '<div style="color: #f59e0b; font-size: 0.875rem;">Desconto: R$ ' + resultado.valorDescontoTotal.toFixed(2) + '</div>';
    }
    html += '</div>';
    html += '<div style="background: #f0fdf4; padding: 1rem; border-radius: 8px;">';
    html += '<div style="color: #16a34a; font-size: 0.875rem;">Cliente Paga</div>';
    html += '<div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">R$ ' + resultado.precoFinalCliente.toFixed(2) + '</div>';
    html += '</div>';
    html += '</div>';
    
    // Breakdown de custos
    html += '<div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">';
    html += '<h4 style="margin: 0 0 0.75rem 0;">üí∞ Breakdown de Custos</h4>';
    html += '<div style="display: grid; gap: 0.5rem;">';
    html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">';
    html += '<span>Custo Base:</span><strong>R$ ' + resultado.custo.toFixed(2) + '</strong>';
    html += '</div>';
    
    for (var i = 0; i < resultado.gastosDetalhados.length; i++) {
        var gasto = resultado.gastosDetalhados[i];
        html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 4px;">';
        html += '<span>' + gasto.nome + ':</span><strong>R$ ' + gasto.valor.toFixed(2) + '</strong>';
        html += '</div>';
    }
    
    html += '<div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f3f4f6; border-radius: 4px; border-top: 2px solid #e5e7eb; margin-top: 0.5rem;">';
    html += '<span><strong>Total de Custos:</strong></span><strong style="color: #dc2626;">R$ ' + resultado.totalCustos.toFixed(2) + '</strong>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Lucro e margens
    html += '<div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem;">';
    html += '<h4 style="margin: 0 0 0.75rem 0; color: #15803d;">üí∞ Lucro Final</h4>';
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
    html += '<div>';
    html += '<div style="color: #15803d; font-size: 0.875rem;">Lucro L√≠quido</div>';
    html += '<div style="font-size: 1.75rem; font-weight: 800; color: ' + (resultado.lucroLiquido >= 0 ? '#15803d' : '#dc2626') + ';">R$ ' + resultado.lucroLiquido.toFixed(2) + '</div>';
    html += '</div>';
    html += '<div>';
    html += '<div style="color: #15803d; font-size: 0.875rem;">Margem sobre Venda</div>';
    html += '<div style="font-size: 1.75rem; font-weight: 800; color: #15803d;">' + resultado.margemSobreVenda.toFixed(2) + '%</div>';
    html += '</div>';
    html += '</div>';
    html += '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(34, 197, 94, 0.3);">';
    html += '<div style="color: #15803d; font-size: 0.875rem;">Margem sobre Custo (refer√™ncia)</div>';
    html += '<div style="font-size: 1.25rem; font-weight: 700; color: #15803d;">' + resultado.margemSobreCusto.toFixed(2) + '%</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<button onclick="fecharModal()" class="btn btn-gray" style="width: 100%; margin-top: 1rem;">Fechar</button>';
    html += '</div>';
    
    // Mostrar em modal
    mostrarModal(html);
}

// Fun√ß√µes auxiliares de modal (criar se n√£o existir)
function mostrarModal(conteudo) {
    var modal = document.getElementById('modalDetalhamento');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalDetalhamento';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 1rem;';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = '<div style="background: white; border-radius: 16px; padding: 2rem; max-width: 90vw; max-height: 90vh; overflow-y: auto;">' + conteudo + '</div>';
    modal.style.display = 'flex';
    
    // Fechar ao clicar fora
    modal.onclick = function(e) {
        if (e.target === modal) {
            fecharModal();
        }
    };
}

function fecharModal() {
    var modal = document.getElementById('modalDetalhamento');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Atualizar dados base da an√°lise
function atualizarDadosBaseAnalise() {
    var precoVenda = parseFloat(document.getElementById('precoVendaAtual').value) || 0;
    var custo = parseFloat(document.getElementById('custoAnalise').value) || 0;
    var empresaId = document.getElementById('empresaAnalise').value;
    var marketplaceId = document.getElementById('marketplaceAnalise').value;
    var freteImposto = parseFloat(document.getElementById('freteAnalise').value) || 0;
    var freteComissao = parseFloat(document.getElementById('freteComissaoAnalise').value) || 0;
    
    // Atualizar todos os cen√°rios
    for (var i = 0; i < cenarios.length; i++) {
        cenarios[i].precoVenda = precoVenda;
        cenarios[i].custo = custo;
        cenarios[i].empresaId = empresaId;
        cenarios[i].marketplaceId = marketplaceId;
        cenarios[i].freteParaImposto = freteImposto;
        cenarios[i].freteParaComissao = freteComissao;
    }
    
    atualizarListaCenarios();
}

// Atualizar selects da tela de an√°lise
function atualizarSelectsAnalise() {
    var selectEmpresa = document.getElementById('analiseEmpresaBase');
    var selectMarketplace = document.getElementById('analiseMarketplaceBase');
    
    if (!selectEmpresa || !selectMarketplace) return;
    
    selectEmpresa.innerHTML = '<option value="">Selecione...</option>';
    selectMarketplace.innerHTML = '<option value="">Selecione...</option>';
    
    for (var i = 0; i < empresas.length; i++) {
        var option = document.createElement('option');
        option.value = empresas[i].id;
        option.textContent = empresas[i].nome;
        selectEmpresa.appendChild(option);
    }
    
    for (var i = 0; i < marketplaces.length; i++) {
        var option = document.createElement('option');
        option.value = marketplaces[i].id;
        option.textContent = marketplaces[i].nome;
        selectMarketplace.appendChild(option);
    }
}

console.log("‚úÖ M√≥dulo de An√°lise Reversa carregado com sucesso!");


// ================================================================================
// INICIALIZA√á√ÉO AUTOM√ÅTICA QUANDO A TELA DE AN√ÅLISE √â MOSTRADA
// ================================================================================
(function() {
    console.log('üîß Configurando inicializa√ß√£o autom√°tica...');
    
    // Sobrescrever a fun√ß√£o mostrarTela original para garantir inicializa√ß√£o
    // ================================================================================
// CORRE√á√ÉO: SOBRESCREVER mostrarTela SEM CHAMAR ORIGINAL
// ================================================================================
window.mostrarTela = function(tela) {
    console.log('üì± mostrarTela() chamada para:', tela);
    
    // Pegar elementos
    var telaCalculo = document.getElementById('telaCalculo');
    var telaLote = document.getElementById('telaLote');
    var telaConfig = document.getElementById('telaConfig');
    var telaAnalise = document.getElementById('telaAnalise');
    
    // Ocultar todas
    if (telaCalculo) telaCalculo.style.cssText = 'display: none !important';
    if (telaLote) telaLote.style.cssText = 'display: none !important';
    if (telaConfig) telaConfig.style.cssText = 'display: none !important';
    if (telaAnalise) telaAnalise.style.cssText = 'display: none !important';
    
    // Mostrar a solicitada
    if (tela === 'calculo' && telaCalculo) {
        telaCalculo.style.cssText = 'display: block !important';
    } else if (tela === 'lote' && telaLote) {
        telaLote.style.cssText = 'display: block !important';
    } else if (tela === 'config' && telaConfig) {
        telaConfig.style.cssText = 'display: block !important';
    } else if (tela === 'analise' && telaAnalise) {
        telaAnalise.style.cssText = 'display: block !important';
        console.log('‚úÖ Tela An√°lise exibida!');
        
        // Inicializar
        setTimeout(function() {
            if (typeof atualizarSelectsAnalise === 'function') atualizarSelectsAnalise();
            if (!window.cenarios || cenarios.length === 0) {
                if (typeof inicializarAnalise === 'function') inicializarAnalise();
            }
            if (typeof atualizarListaCenarios === 'function') atualizarListaCenarios();
        }, 150);
    }
    
    // Atualizar bot√µes
    var btnCalculo = document.getElementById('btnCalculo');
    var btnLote = document.getElementById('btnLote');
    var btnConfig = document.getElementById('btnConfig');
    var btnAnalise = document.getElementById('btnAnalise');
    
    if (btnCalculo) btnCalculo.className = 'btn ' + (tela === 'calculo' ? 'btn-blue' : 'btn-gray');
    if (btnLote) btnLote.className = 'btn ' + (tela === 'lote' ? 'btn-blue' : 'btn-gray');
    if (btnConfig) btnConfig.className = 'btn ' + (tela === 'config' ? 'btn-blue' : 'btn-gray');
    if (btnAnalise) btnAnalise.className = 'btn ' + (tela === 'analise' ? 'btn-blue' : 'btn-gray');
};
    
    console.log('‚úÖ Inicializa√ß√£o autom√°tica configurada!');


// ================================================================================
// FUN√á√ÉO DE C√ÅLCULO DE CEN√ÅRIOS - CORRIGIDA
// ================================================================================
function calcularCenario(cenarioId) {
    console.log('üî¢ Calculando cen√°rio:', cenarioId);
    
    // Pegar valores BASE dos campos principais
    var precoVenda = parseFloat(document.getElementById('analisePrecoVendaBase').value) || 0;
    var custo = parseFloat(document.getElementById('analiseCustoBase').value) || 0;
    var empresaId = document.getElementById('analiseEmpresaBase').value;
    var marketplaceId = document.getElementById('analiseMarketplaceBase').value;
    
    // Validar campos obrigat√≥rios
    if (!precoVenda || !custo || !empresaId || !marketplaceId) {
        alert('Preencha todos os campos obrigat√≥rios (Pre√ßo de Venda, Custo, Empresa e Marketplace)');
        return;
    }
    
    // Encontrar o cen√°rio
    var cenario = cenarios.find(function(c) { return c.id == cenarioId; });
    if (!cenario) {
        console.error('Cen√°rio n√£o encontrado:', cenarioId);
        return;
    }
    
    // Pegar valores do cen√°rio
    var descontoMkt = parseFloat(cenario.descontoMarketplace) || 0;
    var coPartic = parseFloat(cenario.coParticipacao) || 0;
    
    // Encontrar empresa e marketplace
    var empresa = empresas.find(function(e) { return e.id == empresaId; });
    var marketplace = marketplaces.find(function(m) { return m.id == marketplaceId; });
    
    if (!empresa || !marketplace) {
        alert('Empresa ou Marketplace n√£o encontrado!');
        console.error('Empresa:', empresa, 'Marketplace:', marketplace);
        return;
    }
    
    // Pegar percentuais (usando os nomes CORRETOS dos campos)
    var percComissao = parseFloat(marketplace.comissaoPercentual) || 0;
    var percImpostos = parseFloat(empresa.impostoPercentual) || 0;
    
    // ========================================================================
    // C√ÅLCULOS
    // ========================================================================
    
    // Pre√ßo com desconto do marketplace
    var precoComDesconto = precoVenda * (1 - descontoMkt/100);
    var descontoValor = precoVenda * (descontoMkt/100);
    
    // Co-participa√ß√£o sobre PRE√áO ORIGINAL
    var coParticValor = precoVenda * (coPartic/100);
    
    // Comiss√£o e impostos sobre pre√ßo com desconto
    var comissao = precoComDesconto * (percComissao/100);
    var impostos = precoComDesconto * (percImpostos/100);
    
    // Custo total (co-participa√ß√£o REDUZ o custo)
    var custoTotal = custo + comissao + impostos - coParticValor;
    
    // Lucro e margem
    var lucro = precoComDesconto - custoTotal;
    var margem = (lucro / precoComDesconto) * 100;
    
    // ========================================================================
    // DETERMINAR COR E N√çVEL DO ALERTA
    // ========================================================================
    var cor, nivel;
    if (lucro < 0) {
        cor = '#dc2626';
        nivel = 'PREJU√çZO';
    } else if (margem < 3) {
        cor = '#dc2626';
        nivel = 'RUIM';
    } else if (margem < 7) {
        cor = '#f97316';
        nivel = 'ATEN√á√ÉO';
    } else if (margem < 10) {
        cor = '#eab308';
        nivel = 'M√âDIO';
    } else {
        cor = '#16a34a';
        nivel = 'BOM';
    }
    
    // ========================================================================
    // EXIBIR RESULTADO
    // ========================================================================
    
    // Procurar elemento resultado
    var resultDiv = document.getElementById('resultado-' + cenarioId);
    
    // Se n√£o existir, criar
    if (!resultDiv) {
        console.log('Elemento resultado n√£o encontrado, criando...');
        
        // Tentar encontrar o card do cen√°rio
        var cenarioCard = document.getElementById('cenario-' + cenarioId);
        
        if (!cenarioCard) {
            // Se n√£o encontrar, adicionar ao container principal
            cenarioCard = document.getElementById('listaCenarios');
        }
        
        if (cenarioCard) {
            resultDiv = document.createElement('div');
            resultDiv.id = 'resultado-' + cenarioId;
            resultDiv.style.marginTop = '20px';
            cenarioCard.appendChild(resultDiv);
        } else {
            console.error('N√£o foi poss√≠vel criar elemento resultado!');
            return;
        }
    }
    
    // Renderizar resultado
    resultDiv.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${cor}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <h2 style="margin: 0 0 20px 0; color: ${cor}; font-size: 1.5rem;">üìä ${nivel}</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Pre√ßo Final</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">R$ ${precoComDesconto.toFixed(2)}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Lucro</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${cor};">R$ ${lucro.toFixed(2)}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Margem</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${cor};">${margem.toFixed(2)}%</div>
                </div>
            </div>
            
            <div style="padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #475569;">
                <strong>Detalhamento:</strong><br>
                Pre√ßo Original: R$ ${precoVenda.toFixed(2)}<br>
                Desconto Marketplace (${descontoMkt}%): -R$ ${descontoValor.toFixed(2)}<br>
                Co-participa√ß√£o (${coPartic}%): -R$ ${coParticValor.toFixed(2)}<br>
                Comiss√£o (${percComissao}%): -R$ ${comissao.toFixed(2)}<br>
                Impostos (${percImpostos}%): -R$ ${impostos.toFixed(2)}<br>
                Custo Produto: -R$ ${custo.toFixed(2)}<br>
                <strong>Custo Total: R$ ${custoTotal.toFixed(2)}</strong>
            </div>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    
    // Scroll para o resultado
    setTimeout(function() {
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    console.log('‚úÖ C√°lculo conclu√≠do e resultado exibido!');
}

})();
    </script>
<script>


// ================================================================================
// C√ÅLCULO AUTOM√ÅTICO DA SITUA√á√ÉO ATUAL
// ================================================================================
function calcularSituacaoAtualAutomatica() {
    console.log('‚ö° Calculando Situa√ß√£o Atual automaticamente...');
    
    // Sempre calcular o cen√°rio ID 1 (Situa√ß√£o Atual)
    if (cenarios.length > 0 && cenarios[0].id === 1) {
        // IMPORTANTE: Atualizar o cen√°rio com os valores dos campos BASE
        cenarios[0].precoVenda = parseFloat(document.getElementById('analisePrecoVendaBase').value) || 0;
        cenarios[0].custo = parseFloat(document.getElementById('analiseCustoBase').value) || 0;
        cenarios[0].empresaId = document.getElementById('analiseEmpresaBase').value;
        cenarios[0].marketplaceId = document.getElementById('analiseMarketplaceBase').value;
        
        // Ler frete e checkboxes
        var freteInput = document.getElementById('analiseFreteBase');
        var frete = freteInput ? (parseFloat(freteInput.value) || 0) : 0;
        
        var freteImpostoCheck = document.getElementById('analiseFreteParaImpostoBase');
        var freteComissaoCheck = document.getElementById('analiseFreteParaComissaoBase');
        
        cenarios[0].freteParaImposto = (freteImpostoCheck && freteImpostoCheck.checked) ? frete : 0;
        cenarios[0].freteParaComissao = (freteComissaoCheck && freteComissaoCheck.checked) ? frete : 0;
        
        console.log('üìä Valores atualizados:', cenarios[0]);
        
        // Calcular com os valores atualizados
        var resultado = calcularCenarioReverso(cenarios[0]);
        if (resultado) {
            cenarios[0].resultado = resultado;
            atualizarListaCenarios();
            console.log('‚úÖ Situa√ß√£o Atual calculada!', resultado);
        } else {
            console.log('‚ö†Ô∏è Campos ainda n√£o preenchidos completamente');
        }
    }
}

// Adicionar event listeners nos campos base
function adicionarEventListenersAnalise() {
    var camposBase = [
        'analisePrecoVendaBase',
        'analiseCustoBase',
        'analiseFreteBase',
        'analiseEmpresaBase',
        'analiseMarketplaceBase',
        'analiseFreteParaImpostoBase',
        'analiseFreteParaComissaoBase'
    ];
    
    camposBase.forEach(function(id) {
        var campo = document.getElementById(id);
        if (campo) {
            if (campo.type === 'checkbox') {
                campo.addEventListener('change', calcularSituacaoAtualAutomatica);
            } else {
                campo.addEventListener('input', calcularSituacaoAtualAutomatica);
                campo.addEventListener('change', calcularSituacaoAtualAutomatica);
            }
        }
    });
    
    console.log('‚úÖ Event listeners adicionados para c√°lculo autom√°tico!');
}

// Chamar ap√≥s inicializar a an√°lise
var inicializarAnaliseOriginal = window.inicializarAnalise;
window.inicializarAnalise = function() {
    if (inicializarAnaliseOriginal) {
        inicializarAnaliseOriginal();
    }
    
    // Adicionar event listeners ap√≥s um pequeno delay
    setTimeout(function() {
        adicionarEventListenersAnalise();
        // Calcular automaticamente se j√° houver dados
        calcularSituacaoAtualAutomatica();
    }, 100);
};


// ================================================================================
// SOBRESCRITA FOR√áADA DA FUN√á√ÉO calcularCenario
// Esta fun√ß√£o √© executada por √öLTIMO e garante que seja a vers√£o correta
// ================================================================================
window.calcularCenario = function(cenarioId) {
    console.log('üî¢ Calculando cen√°rio (vers√£o correta):', cenarioId);
    
    // Pegar valores BASE dos campos
    var precoVenda = parseFloat(document.getElementById('analisePrecoVendaBase').value) || 0;
    var custo = parseFloat(document.getElementById('analiseCustoBase').value) || 0;
    var empresaId = document.getElementById('analiseEmpresaBase').value;
    var marketplaceId = document.getElementById('analiseMarketplaceBase').value;
    
    console.log('üìä Valores lidos:', {precoVenda, custo, empresaId, marketplaceId});
    
    // Validar campos obrigat√≥rios
    if (!precoVenda || !custo || !empresaId || !marketplaceId) {
        alert('Preencha todos os campos obrigat√≥rios (Pre√ßo de Venda, Custo, Empresa e Marketplace)');
        return;
    }
    
    // Encontrar cen√°rio
    var cenario = cenarios.find(function(c) { return c.id == cenarioId; });
    if (!cenario) {
        console.error('Cen√°rio n√£o encontrado:', cenarioId);
        return;
    }
    
    var descontoMkt = parseFloat(cenario.descontoMarketplace) || 0;
    var coPartic = parseFloat(cenario.coParticipacao) || 0;
    
    // Encontrar empresa e marketplace
    var empresa = empresas.find(function(e) { return e.id == empresaId; });
    var marketplace = marketplaces.find(function(m) { return m.id == marketplaceId; });
    
    if (!empresa || !marketplace) {
        alert('Empresa ou Marketplace n√£o encontrado!');
        return;
    }
    
    // Usar nomes CORRETOS dos campos
    var percComissao = parseFloat(marketplace.comissaoPercentual) || 0;
    var percImpostos = parseFloat(empresa.impostoPercentual) || 0;
    
    console.log('üí∞ Percentuais:', {percComissao, percImpostos});
    
    // C√ÅLCULOS
    var precoComDesconto = precoVenda * (1 - descontoMkt/100);
    var descontoValor = precoVenda * (descontoMkt/100);
    
    // Co-participa√ß√£o sobre PRE√áO ORIGINAL
    var coParticValor = precoVenda * (coPartic/100);
    
    var comissao = precoComDesconto * (percComissao/100);
    var impostos = precoComDesconto * (percImpostos/100);
    
    var custoTotal = custo + comissao + impostos - coParticValor;
    var lucro = precoComDesconto - custoTotal;
    var margem = (lucro / precoComDesconto) * 100;
    
    // Determinar cor e n√≠vel
    var cor, nivel;
    if (lucro < 0) {
        cor = '#dc2626';
        nivel = 'PREJU√çZO';
    } else if (margem < 3) {
        cor = '#dc2626';
        nivel = 'RUIM';
    } else if (margem < 7) {
        cor = '#f97316';
        nivel = 'ATEN√á√ÉO';
    } else if (margem < 10) {
        cor = '#eab308';
        nivel = 'M√âDIO';
    } else {
        cor = '#16a34a';
        nivel = 'BOM';
    }
    
    // Elemento resultado
    var resultDiv = document.getElementById('resultado-' + cenarioId);
    
    if (!resultDiv) {
        var cenarioCard = document.getElementById('cenario-' + cenarioId);
        if (!cenarioCard) {
            cenarioCard = document.getElementById('listaCenarios');
        }
        if (cenarioCard) {
            resultDiv = document.createElement('div');
            resultDiv.id = 'resultado-' + cenarioId;
            resultDiv.style.marginTop = '20px';
            cenarioCard.appendChild(resultDiv);
        }
    }
    
    if (resultDiv) {
        resultDiv.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ${cor}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <h2 style="margin: 0 0 20px 0; color: ${cor}; font-size: 1.5rem;">üìä ${nivel}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Pre√ßo Final</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">R$ ${precoComDesconto.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Lucro</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: ${cor};">R$ ${lucro.toFixed(2)}</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Margem</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: ${cor};">${margem.toFixed(2)}%</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #475569;">
                    <strong>Detalhamento:</strong><br>
                    Pre√ßo Original: R$ ${precoVenda.toFixed(2)}<br>
                    Desconto Marketplace (${descontoMkt}%): -R$ ${descontoValor.toFixed(2)}<br>
                    Co-participa√ß√£o (${coPartic}%): -R$ ${coParticValor.toFixed(2)}<br>
                    Comiss√£o (${percComissao}%): -R$ ${comissao.toFixed(2)}<br>
                    Impostos (${percImpostos}%): -R$ ${impostos.toFixed(2)}<br>
                    Custo Produto: -R$ ${custo.toFixed(2)}<br>
                    <strong>Custo Total: R$ ${custoTotal.toFixed(2)}</strong>
                </div>
            </div>
        `;
        resultDiv.style.display = 'block';
        
        setTimeout(function() {
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
        
        console.log('‚úÖ Resultado exibido com sucesso!');
    }
};

console.log('‚úÖ Fun√ß√£o calcularCenario() SOBRESCRITA com vers√£o correta!');

</script>

<script>
// ================================================================================
// FUN√á√ïES CORRETAS - AN√ÅLISE REVERSA COM FRETE
// ================================================================================

// Fun√ß√£o para calcular cen√°rio individual
window.calcularCenario = function(cenarioId) {
    console.log('üî¢ Calculando cen√°rio:', cenarioId);
    
    // Pegar valores BASE
    var precoVenda = parseFloat(document.getElementById('analisePrecoVendaBase').value) || 0;
    var custo = parseFloat(document.getElementById('analiseCustoBase').value) || 0;
    var freteInput = document.getElementById('analiseFreteBase');
    var frete = freteInput ? (parseFloat(freteInput.value) || 0) : 0;
    var empresaId = document.getElementById('analiseEmpresaBase').value;
    var marketplaceId = document.getElementById('analiseMarketplaceBase').value;
    
    // Checkboxes (IDs corretos do HTML)
    var freteBaseImpostoEl = document.getElementById('analiseFreteParaImpostoBase');
    var freteBaseComissaoEl = document.getElementById('analiseFreteParaComissaoBase');
    var freteBaseImposto = freteBaseImpostoEl ? freteBaseImpostoEl.checked : false;
    var freteBaseComissao = freteBaseComissaoEl ? freteBaseComissaoEl.checked : false;
    
    // Validar
    if (!precoVenda || !custo || !empresaId || !marketplaceId) {
        alert('Preencha todos os campos obrigat√≥rios (Pre√ßo de Venda, Custo, Empresa e Marketplace)');
        return;
    }
    
    // Encontrar cen√°rio
    var cenario = cenarios.find(function(c) { return c.id == cenarioId; });
    if (!cenario) return;
    
    var descontoMkt = parseFloat(cenario.descontoMarketplace) || 0;
    var coPartic = parseFloat(cenario.coParticipacao) || 0;
    
    // Encontrar empresa e marketplace
    var empresa = empresas.find(function(e) { return e.id == empresaId; });
    var marketplace = marketplaces.find(function(m) { return m.id == marketplaceId; });
    
    if (!empresa || !marketplace) {
        alert('Empresa ou Marketplace n√£o encontrado!');
        return;
    }
    
    // Percentuais (nomes corretos dos campos)
    var percComissao = parseFloat(marketplace.comissaoPercentual) || 0;
    var percImpostos = parseFloat(empresa.impostoPercentual) || 0;
    
    // C√ÅLCULOS
    var precoComDesconto = precoVenda * (1 - descontoMkt/100);
    var descontoValor = precoVenda * (descontoMkt/100);
    var coParticValor = precoVenda * (coPartic/100);
    var comissao = precoComDesconto * (percComissao/100);
    var impostos = precoComDesconto * (percImpostos/100);
    
    // C√°lculo do frete
    var freteImposto = 0;
    var freteComissao = 0;
    
    if (frete > 0) {
        if (freteBaseImposto) {
            freteImposto = frete * (percImpostos/100);
        }
        if (freteBaseComissao) {
            freteComissao = frete * (percComissao/100);
        }
    }
    
    // Custo total (descontos de frete REDUZEM o custo)
    var custoTotal = custo + comissao + impostos - coParticValor - freteImposto - freteComissao;
    var lucro = precoComDesconto - custoTotal;
    var margem = (lucro / precoComDesconto) * 100;
    
    // Determinar cor e n√≠vel
    var cor, nivel;
    if (lucro < 0) {
        cor = '#dc2626'; nivel = 'PREJU√çZO';
    } else if (margem < 3) {
        cor = '#dc2626'; nivel = 'RUIM';
    } else if (margem < 7) {
        cor = '#f97316'; nivel = 'ATEN√á√ÉO';
    } else if (margem < 10) {
        cor = '#eab308'; nivel = 'M√âDIO';
    } else {
        cor = '#16a34a'; nivel = 'BOM';
    }
    
    // Elemento resultado
    var resultDiv = document.getElementById('resultado-' + cenarioId);
    
    if (!resultDiv) {
        var cenarioCard = document.getElementById('cenario-' + cenarioId);
        if (!cenarioCard) cenarioCard = document.getElementById('listaCenarios');
        if (cenarioCard) {
            resultDiv = document.createElement('div');
            resultDiv.id = 'resultado-' + cenarioId;
            resultDiv.style.marginTop = '20px';
            cenarioCard.appendChild(resultDiv);
        }
    }
    
    if (resultDiv) {
        var freteDetalhes = '';
        if (frete > 0) {
            freteDetalhes = 'Frete: R$ ' + frete.toFixed(2) + '<br>';
            if (freteImposto > 0) {
                freteDetalhes += 'Desconto Imposto s/ Frete (' + percImpostos + '%): -R$ ' + freteImposto.toFixed(2) + '<br>';
            }
            if (freteComissao > 0) {
                freteDetalhes += 'Desconto Comiss√£o s/ Frete (' + percComissao + '%): -R$ ' + freteComissao.toFixed(2) + '<br>';
            }
        }
        
        resultDiv.innerHTML = '<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid ' + cor + '; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">' +
            '<h2 style="margin: 0 0 20px 0; color: ' + cor + '; font-size: 1.5rem;">üìä ' + nivel + '</h2>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px;">' +
                '<div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">' +
                    '<div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Pre√ßo Final</div>' +
                    '<div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">R$ ' + precoComDesconto.toFixed(2) + '</div>' +
                '</div>' +
                '<div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">' +
                    '<div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Lucro</div>' +
                    '<div style="font-size: 1.5rem; font-weight: 700; color: ' + cor + ';">R$ ' + lucro.toFixed(2) + '</div>' +
                '</div>' +
                '<div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 8px;">' +
                    '<div style="color: #64748b; font-size: 0.875rem; margin-bottom: 5px;">Margem</div>' +
                    '<div style="font-size: 1.5rem; font-weight: 700; color: ' + cor + ';">' + margem.toFixed(2) + '%</div>' +
                '</div>' +
            '</div>' +
            '<div style="padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #475569;">' +
                '<strong>Detalhamento:</strong><br>' +
                'Pre√ßo Original: R$ ' + precoVenda.toFixed(2) + '<br>' +
                'Desconto Marketplace (' + descontoMkt + '%): -R$ ' + descontoValor.toFixed(2) + '<br>' +
                'Co-participa√ß√£o (' + coPartic + '%): -R$ ' + coParticValor.toFixed(2) + '<br>' +
                'Comiss√£o (' + percComissao + '%): -R$ ' + comissao.toFixed(2) + '<br>' +
                'Impostos (' + percImpostos + '%): -R$ ' + impostos.toFixed(2) + '<br>' +
                freteDetalhes +
                'Custo Produto: -R$ ' + custo.toFixed(2) + '<br>' +
                '<strong>Custo Total: R$ ' + custoTotal.toFixed(2) + '</strong>' +
            '</div>' +
        '</div>';
        
        resultDiv.style.display = 'block';
        setTimeout(function() {
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
    
    console.log('‚úÖ C√°lculo conclu√≠do!');
};

// Fun√ß√£o para calcular todos os cen√°rios
window.calcularTodosCenarios = function() {
    console.log('üî¢ Calculando todos os cen√°rios...');
    
    // Validar campos base
    var precoVenda = parseFloat(document.getElementById('analisePrecoVendaBase').value) || 0;
    var custo = parseFloat(document.getElementById('analiseCustoBase').value) || 0;
    var empresaId = document.getElementById('analiseEmpresaBase').value;
    var marketplaceId = document.getElementById('analiseMarketplaceBase').value;
    
    if (!precoVenda || !custo || !empresaId || !marketplaceId) {
        alert('Preencha os campos base antes de calcular todos os cen√°rios!');
        return;
    }
    
    // Calcular cada cen√°rio
    for (var i = 0; i < cenarios.length; i++) {
        calcularCenario(cenarios[i].id);
    }
    
    console.log('‚úÖ Todos os cen√°rios calculados!');
};

console.log('‚úÖ Fun√ß√µes calcularCenario() e calcularTodosCenarios() carregadas!');
</script>

</body>
</html>
