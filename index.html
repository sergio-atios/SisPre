<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisPre Pro - Sistema de Precifica√ß√£o</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Bibliotecas para processamento de arquivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            /* Cores Vibrantes (Abstract Blob) */
            --color-vibrant-orange: #ff7e5f;
            --color-vibrant-purple: #9333ea;
            --color-vibrant-cyan: #06b6d4;
            --color-dark-bg: #1a202c;
            --color-dark-card: #2d3748;
            --color-mint-green: #34d399;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-dark-bg);
            color: white;
            min-height: 100vh;
        }

        /* Background com formas org√¢nicas/blobs */
        .abstract-blob-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 450px;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .abstract-blob-bg::before,
        .abstract-blob-bg::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.6;
            filter: blur(80px);
        }

        /* Blob Laranja/Roxo Esquerda */
        .abstract-blob-bg::before {
            width: 500px;
            height: 500px;
            top: -150px;
            left: -100px;
            background: radial-gradient(circle, var(--color-vibrant-orange) 0%, var(--color-vibrant-purple) 70%);
            animation: pulse-blob 10s infinite alternate;
        }

        /* Blob Ciano/Turquesa Direita */
        .abstract-blob-bg::after {
            width: 400px;
            height: 400px;
            top: 50px;
            right: -50px;
            background: radial-gradient(circle, var(--color-vibrant-cyan) 0%, var(--color-dark-bg) 70%);
            animation: pulse-blob 8s infinite reverse;
        }

        @keyframes pulse-blob {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.05) translate(5%, 5%); }
            100% { transform: scale(1) translate(0, 0); }
        }

        /* Orbes 3D de Decora√ß√£o */
        .orb-3d {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, var(--color-vibrant-purple) 70%);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transform: rotateX(20deg) rotateY(-10deg);
            display: inline-block;
        }

        /* Cards (Neobrutalism Suave) */
        .card-neobrutal {
            background-color: var(--color-dark-card);
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Inputs */
        .input-neobrutal {
            background-color: #1a202c;
            border: 1px solid var(--color-vibrant-cyan);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            width: 100%;
        }
        .input-neobrutal:focus {
            outline: none;
            border-color: var(--color-vibrant-orange);
            box-shadow: 0 0 0 2px rgba(255, 126, 95, 0.3);
        }

        /* Bot√£o Prim√°rio */
        .btn-primary {
            background-color: var(--color-vibrant-orange);
            color: var(--color-dark-bg);
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 8px 15px rgba(255, 126, 95, 0.4);
            cursor: pointer;
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--color-vibrant-cyan);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.6);
            transform: scale(1.05);
        }

        /* Bot√µes de Navega√ß√£o (C√≠rculos) */
        .nav-circle {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--color-dark-card);
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-circle.active {
            background-color: var(--color-vibrant-cyan);
            box-shadow: 0 0 15px var(--color-vibrant-cyan);
        }
        .nav-circle:not(.active):hover {
            background-color: var(--color-vibrant-orange);
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-dark-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-vibrant-cyan);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-vibrant-orange);
        }

        /* Anima√ß√£o de fade in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <!-- Background com formas org√¢nicas -->
    <div class="abstract-blob-bg"></div>

    <div id="app" class="relative z-10 w-full max-w-7xl mx-auto p-4 sm:p-8 space-y-8">
        <!-- HEADER -->
        <header class="flex justify-between items-center p-6 card-neobrutal bg-opacity-70 backdrop-blur-sm">
            <div class="flex items-center space-x-4">
                <!-- Logo: Esfera 3D -->
                <div class="orb-3d w-10 h-10 flex items-center justify-center bg-purple-600">
                    <i data-lucide="bar-chart-3" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-white">SisPre Pro</h1>
                    <p class="text-sm text-gray-400">Sistema de Precifica√ß√£o para Marketplaces</p>
                </div>
            </div>
            
            <!-- Barra de Status -->
            <div class="hidden sm:flex items-center space-x-2 p-2 rounded-full bg-gray-800 border border-cyan-500">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                <span class="text-xs text-gray-300 pr-2">Salvamento Autom√°tico</span>
            </div>
        </header>

        <!-- NAVEGA√á√ÉO -->
        <nav class="flex justify-center space-x-8 py-4">
            <div class="nav-item flex flex-col items-center space-y-1 cursor-pointer" data-section="calcular">
                <div class="nav-circle active">
                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-xs font-medium text-white">Calcular</span>
            </div>
            <div class="nav-item flex flex-col items-center space-y-1 cursor-pointer" data-section="lote">
                <div class="nav-circle">
                    <i data-lucide="package" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-xs font-medium text-gray-400">Lote</span>
            </div>
            <div class="nav-item flex flex-col items-center space-y-1 cursor-pointer" data-section="analise">
                <div class="nav-circle">
                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-xs font-medium text-gray-400">An√°lise</span>
            </div>
            <div class="nav-item flex flex-col items-center space-y-1 cursor-pointer" data-section="configuracoes">
                <div class="nav-circle">
                    <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                </div>
                <span class="text-xs font-medium text-gray-400">Config</span>
            </div>
        </nav>

        <!-- SE√á√ÉO: CALCULAR (Principal) -->
        <section id="calcular" class="fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Formul√°rio de Entrada -->
                <div class="p-8 card-neobrutal space-y-6">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i data-lucide="file-text" class="w-6 h-6 mr-2 text-cyan-400"></i>
                        Dados do Produto
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Produto</label>
                            <input type="text" id="nomeProduto" class="input-neobrutal" placeholder="Digite o nome do produto">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custo do Produto (R$)</label>
                            <input type="number" id="custoProduto" class="input-neobrutal" placeholder="0.00" step="0.01">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Empresa</label>
                                <select id="empresaSelecionada" class="input-neobrutal">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Marketplace</label>
                                <select id="marketplaceSelecionado" class="input-neobrutal">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Margem de Lucro (%)</label>
                            <div class="flex gap-2">
                                <input type="number" id="margemLucro" class="input-neobrutal flex-1" placeholder="0.00" step="0.01">
                                <select id="tipoMargem" class="input-neobrutal w-auto">
                                    <option value="venda">Sobre Venda</option>
                                    <option value="custo">Sobre Custo</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-400 mt-1" id="descricaoMargem">
                                Porcentagem de lucro sobre o valor de venda final
                            </p>
                        </div>

                        <div class="p-4 bg-yellow-900/20 border border-yellow-600 rounded-lg">
                            <h4 class="font-medium mb-3 text-yellow-400">üí∞ Configura√ß√£o de Descontos</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Desconto Marketplace (%)</label>
                                    <input type="number" id="descontoMarketplace" class="input-neobrutal text-sm" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Co-participa√ß√£o Vendedor (%)</label>
                                    <input type="number" id="coParticipacaoVendedor" class="input-neobrutal text-sm" placeholder="0.00" step="0.01">
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-cyan-900/20 border border-cyan-600 rounded-lg">
                            <h4 class="font-medium mb-3 text-cyan-400">üöö Configura√ß√£o de Frete</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Frete p/ Base de Imposto (R$)</label>
                                    <input type="number" id="freteParaImposto" class="input-neobrutal text-sm" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Frete p/ Comiss√£o Marketplace (R$)</label>
                                    <input type="number" id="freteParaComissao" class="input-neobrutal text-sm" placeholder="0.00" step="0.01">
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium text-gray-300">Gastos Adicionais</label>
                                <button onclick="adicionarGastoAdicional()" class="text-cyan-400 hover:text-cyan-300 text-sm">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                            <div id="gastosAdicionais"></div>
                        </div>

                        <button id="btnCalcular" onclick="calcular()" class="btn-primary w-full text-white">
                            üßÆ Calcular Pre√ßo
                        </button>
                    </div>
                </div>

                <!-- Resultado -->
                <div class="p-8 card-neobrutal">
                    <h2 class="text-2xl font-bold text-white flex items-center mb-6">
                        <i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-orange-400"></i>
                        Resultado do C√°lculo
                    </h2>
                    <div id="resultado">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üßÆ</div>
                            <p class="text-gray-400">Preencha os dados para ver o c√°lculo</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO: LOTE -->
        <section id="lote" class="hidden fade-in">
            <div class="p-8 card-neobrutal">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center">
                    <i data-lucide="package" class="w-8 h-8 mr-3 text-purple-400"></i>
                    üì¶ Precifica√ß√£o em Lote
                </h2>
                
                <div class="space-y-6">
                    <div class="p-6 bg-yellow-900/20 border border-yellow-600 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-400 mb-3">üìã Upload de Planilha</h3>
                        <p class="text-gray-300 mb-4">Fa√ßa upload de uma planilha Excel ou CSV com seus produtos para calcular os pre√ßos em lote.</p>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label class="btn-primary bg-cyan-600 hover:bg-cyan-700 text-white text-center cursor-pointer flex items-center justify-center">
                                <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                                Selecionar Planilha
                                <input type="file" id="uploadLote" accept=".xlsx,.xls,.csv" style="display: none;" onchange="processarPlanilhaLote(event)">
                            </label>
                            <button onclick="baixarModeloLote()" class="btn-primary text-white" style="background-color: #51fc90; color: #242422; box-shadow: 0 8px 15px rgba(81, 252, 144, 0.4);" onmouseover="this.style.backgroundColor='#3de07a'" onmouseout="this.style.backgroundColor='#51fc90'">
                                <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                Baixar Modelo
                            </button>
                        </div>
                    </div>

                    <div id="resultadoLote" class="hidden">
                        <div class="p-6 card-neobrutal">
                            <h3 class="text-xl font-bold text-white mb-4">Resultados do Processamento</h3>
                            <div id="tabelaResultadosLote" class="overflow-x-auto"></div>
                            
                            <div class="mt-6 flex gap-4">
                                <button onclick="exportarResultadosLote()" class="btn-primary bg-purple-600 hover:bg-purple-700">
                                    üíæ Exportar Resultados
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-cyan-900/20 border border-cyan-600 rounded-lg">
                        <h4 class="font-semibold text-cyan-400 mb-3">‚ÑπÔ∏è Formato da Planilha</h4>
                        <p class="text-gray-300 text-sm mb-2">A planilha deve conter as seguintes colunas:</p>
                        <ul class="text-gray-400 text-sm space-y-1 list-disc list-inside">
                            <li><strong>Nome do Produto</strong> - Nome/descri√ß√£o do item</li>
                            <li><strong>Custo</strong> - Custo do produto em R$</li>
                            <li><strong>Empresa ID</strong> - ID da empresa (veja em Configura√ß√µes)</li>
                            <li><strong>Marketplace ID</strong> - ID do marketplace (veja em Configura√ß√µes)</li>
                            <li><strong>Margem Lucro %</strong> - Percentual desejado de lucro</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO: AN√ÅLISE -->
        <section id="analise" class="hidden fade-in">
            <div class="p-8 card-neobrutal">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center">
                    <i data-lucide="trending-up" class="w-8 h-8 mr-3 text-orange-400"></i>
                    üìà An√°lise Reversa
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formul√°rio de An√°lise -->
                    <div class="space-y-6">
                        <div class="p-6 bg-purple-900/20 border border-purple-600 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-400 mb-4">üéØ Simular Cen√°rios</h3>
                            <p class="text-gray-300 text-sm mb-4">Insira o pre√ßo de venda desejado e simule diferentes cen√°rios de desconto.</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Pre√ßo de Venda Fixo (R$)</label>
                                    <input type="number" id="precoAnalise" class="input-neobrutal" placeholder="100.00" step="0.01">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Custo do Produto (R$)</label>
                                    <input type="number" id="custoAnalise" class="input-neobrutal" placeholder="50.00" step="0.01">
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Empresa</label>
                                        <select id="empresaAnalise" class="input-neobrutal">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Marketplace</label>
                                        <select id="marketplaceAnalise" class="input-neobrutal">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-yellow-900/20 border border-yellow-600 rounded-lg">
                            <h4 class="font-semibold text-yellow-400 mb-3">üí∞ Testar Descontos</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Desconto Marketplace (%)</label>
                                    <input type="number" id="descontoAnalise" class="input-neobrutal text-sm" placeholder="0.00" step="0.01" value="0">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-300 mb-1">Co-participa√ß√£o (%)</label>
                                    <input type="number" id="coparticipacaoAnalise" class="input-neobrutal text-sm" placeholder="0.00" step="0.01" value="0">
                                </div>
                            </div>
                        </div>

                        <button onclick="calcularAnalise()" class="btn-primary w-full text-white">
                            üîç Analisar Cen√°rio
                        </button>
                    </div>

                    <!-- Resultado da An√°lise -->
                    <div class="p-6 card-neobrutal">
                        <h3 class="text-xl font-bold text-white mb-4">Resultado da An√°lise</h3>
                        <div id="resultadoAnalise">
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">üìä</div>
                                <p class="text-gray-400">Preencha os dados para ver a an√°lise</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO: CONFIGURA√á√ïES -->
        <section id="configuracoes" class="hidden fade-in">
            <!-- Backup -->
            <div class="p-6 card-neobrutal mb-6">
                <h3 class="text-xl font-bold text-white mb-4">üíæ Backup e Restaura√ß√£o</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button onclick="exportarConfiguracoes()" class="btn-primary bg-cyan-600 hover:bg-cyan-700 text-white">
                        üíæ Fazer Backup
                    </button>
                    <label class="btn-primary text-center cursor-pointer" style="background-color: #51fc90; color: #242422; box-shadow: 0 8px 15px rgba(81, 252, 144, 0.4);" onmouseover="this.style.backgroundColor='#3de07a'" onmouseout="this.style.backgroundColor='#51fc90'">
                        üìÅ Restaurar Backup
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarConfiguracoes(event)">
                    </label>
                    <button onclick="limparTodosDados()" class="btn-primary text-white">
                        üóëÔ∏è Limpar Tudo
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Empresas -->
                <div class="p-8 card-neobrutal">
                    <h3 class="text-2xl font-bold text-white mb-6">üè¢ Configurar Empresas</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome da Empresa</label>
                            <input type="text" id="nomeNovaEmpresa" class="input-neobrutal" placeholder="Digite o nome da empresa">
                        </div>

                        <div class="p-4 bg-yellow-900/20 border border-yellow-600 rounded-lg">
                            <label class="block text-sm font-medium text-yellow-400 mb-2">üìä Imposto Total (%)</label>
                            <input type="number" id="impostoEmpresa" class="input-neobrutal" placeholder="18.00" step="0.01">
                            <p class="text-xs text-gray-400 mt-2">Soma de todos os impostos (ICMS, PIS, COFINS, etc.)</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium text-gray-300">Outros Custos da Empresa</label>
                                <button onclick="adicionarCustoEmpresa()" class="text-cyan-400 hover:text-cyan-300 text-sm">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                            <div id="custosNovaEmpresa" class="space-y-2"></div>
                        </div>

                        <button onclick="salvarEmpresa()" class="btn-primary w-full text-white">
                            üíæ Salvar Empresa
                        </button>

                        <div>
                            <h4 class="font-medium text-gray-300 mb-3">Empresas Cadastradas</h4>
                            <div id="listaEmpresas" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Marketplaces -->
                <div class="p-8 card-neobrutal">
                    <h3 class="text-2xl font-bold text-white mb-6">üõí Configurar Marketplaces</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Marketplace</label>
                            <input type="text" id="nomeNovoMarketplace" class="input-neobrutal" placeholder="Digite o nome do marketplace">
                        </div>

                        <div class="p-4 bg-green-900/20 border border-green-600 rounded-lg">
                            <label class="block text-sm font-medium text-green-400 mb-2">üè™ Comiss√£o (%)</label>
                            <input type="number" id="comissaoMarketplace" class="input-neobrutal" placeholder="12.00" step="0.01">
                            <p class="text-xs text-gray-400 mt-2">Porcentagem de comiss√£o do marketplace</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium text-gray-300">Outras Taxas</label>
                                <button onclick="adicionarCustoMarketplace()" class="text-cyan-400 hover:text-cyan-300 text-sm">
                                    ‚ûï Adicionar
                                </button>
                            </div>
                            <div id="custosNovoMarketplace" class="space-y-2"></div>
                        </div>

                        <button onclick="salvarMarketplace()" class="btn-primary w-full" style="background-color: #51fc90; color: #242422; box-shadow: 0 8px 15px rgba(81, 252, 144, 0.4);" onmouseover="this.style.backgroundColor='#3de07a'" onmouseout="this.style.backgroundColor='#51fc90'">
                            üíæ Salvar Marketplace
                        </button>

                        <div>
                            <h4 class="font-medium text-gray-300 mb-3">Marketplaces Cadastrados</h4>
                            <div id="listaMarketplaces" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm py-6">
            <p>SisPre Pro - Sistema de Precifica√ß√£o para Marketplaces ¬© 2025</p>
        </footer>
    </div>

    <script>
        // Inicializa os √≠cones Lucide
        lucide.createIcons();

        // ===== NAVEGA√á√ÉO =====
        const sections = ['calcular', 'lote', 'analise', 'configuracoes'];
        const navItems = document.querySelectorAll('.nav-item');

        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const targetSection = this.getAttribute('data-section');
                mostrarTela(targetSection);
            });
        });

        function mostrarTela(tela) {
            // Alterna o estado ativo do menu
            navItems.forEach(nav => {
                const circle = nav.querySelector('.nav-circle');
                const icon = circle.querySelector('i');
                const text = nav.querySelector('span');
                
                circle.classList.remove('active');
                // √çcone sempre branco, apenas o c√≠rculo muda
                text.classList.remove('text-white');
                text.classList.add('text-gray-400');
            });

            const activeNav = document.querySelector(`[data-section="${tela}"]`);
            if (activeNav) {
                const circle = activeNav.querySelector('.nav-circle');
                const text = activeNav.querySelector('span');
                
                circle.classList.add('active');
                // √çcone permanece branco
                text.classList.remove('text-gray-400');
                text.classList.add('text-white');
            }

            // Alterna a visibilidade das se√ß√µes
            sections.forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    if (id === tela) {
                        sectionElement.classList.remove('hidden');
                        sectionElement.classList.add('fade-in');
                    } else {
                        sectionElement.classList.add('hidden');
                    }
                }
            });

            // Atualizar listas se for configura√ß√µes
            if (tela === 'configuracoes') {
                atualizarListas();
            }
            
            // Atualizar dropdowns se for an√°lise
            if (tela === 'analise') {
                atualizarDropdownsAnalise();
            }
            
            // Reinicializar √≠cones ap√≥s mudan√ßa de tela
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }

        // ===== DADOS DO SISTEMA =====
        var empresas = [];
        var marketplaces = [];
        var gastosAdicionais = [];
        var custosNovaEmpresa = [];
        var custosNovoMarketplace = [];

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            configurarEventos();
            atualizarListas();
            lucide.createIcons();
        });

        function configurarEventos() {
            document.getElementById('custoProduto').oninput = calcular;
            document.getElementById('margemLucro').oninput = calcular;
            document.getElementById('descontoMarketplace').oninput = calcular;
            document.getElementById('coParticipacaoVendedor').oninput = calcular;
            document.getElementById('freteParaImposto').oninput = calcular;
            document.getElementById('freteParaComissao').oninput = calcular;
            document.getElementById('tipoMargem').onchange = function() {
                atualizarDescricaoMargem();
                calcular();
            };
            document.getElementById('empresaSelecionada').onchange = calcular;
            document.getElementById('marketplaceSelecionado').onchange = calcular;
            
            atualizarDescricaoMargem();
        }

        function atualizarDescricaoMargem() {
            var tipo = document.getElementById('tipoMargem').value;
            var descricao = document.getElementById('descricaoMargem');
            
            if (tipo === 'venda') {
                descricao.textContent = 'Porcentagem de lucro sobre o valor de venda final';
            } else {
                descricao.textContent = 'Porcentagem de lucro sobre o custo do produto';
            }
        }

        // ===== CARREGAR/SALVAR DADOS =====
        function carregarDados() {
            try {
                var empresasSalvas = JSON.parse(localStorage.getItem('sisPre_empresas') || '[]');
                var marketplacesSalvos = JSON.parse(localStorage.getItem('sisPre_marketplaces') || '[]');
                
                if (empresasSalvas.length === 0) {
                    empresas = [{
                        id: 1,
                        nome: "Zabereta",
                        impostoPercentual: 9.2,
                        custosFixos: [{ nome: "Taxa", valor: 1.47, tipo: "fixo" }]
                    }];
                } else {
                    empresas = empresasSalvas;
                    empresas.forEach(e => {
                        if (typeof e.impostoPercentual === 'undefined') e.impostoPercentual = 0;
                    });
                }
                
                if (marketplacesSalvos.length === 0) {
                    marketplaces = [
                        {
                            id: 1,
                            nome: "Amazon",
                            comissaoPercentual: 16.0,
                            custosFixos: [{ nome: "Taxa", valor: 6.00, tipo: "fixo" }]
                        },
                        {
                            id: 2,
                            nome: "Mercado Livre",
                            comissaoPercentual: 11.0,
                            custosFixos: [
                                { nome: "Taxa Mercado Pago", valor: 4.99, tipo: "porcentagem" },
                                { nome: "Taxa de An√∫ncio", valor: 1.00, tipo: "fixo" }
                            ]
                        }
                    ];
                } else {
                    marketplaces = marketplacesSalvos;
                    marketplaces.forEach(m => {
                        if (typeof m.comissaoPercentual === 'undefined') m.comissaoPercentual = 0;
                    });
                }
                
                salvarDados();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        function salvarDados() {
            localStorage.setItem('sisPre_empresas', JSON.stringify(empresas));
            localStorage.setItem('sisPre_marketplaces', JSON.stringify(marketplaces));
        }

        function atualizarListas() {
            var selectEmpresa = document.getElementById('empresaSelecionada');
            var selectMarketplace = document.getElementById('marketplaceSelecionado');
            
            selectEmpresa.innerHTML = '<option value="">Selecione...</option>';
            selectMarketplace.innerHTML = '<option value="">Selecione...</option>';
            
            empresas.forEach(empresa => {
                selectEmpresa.innerHTML += `<option value="${empresa.id}">${empresa.nome}</option>`;
            });
            
            marketplaces.forEach(marketplace => {
                selectMarketplace.innerHTML += `<option value="${marketplace.id}">${marketplace.nome}</option>`;
            });
            
            atualizarListaEmpresas();
            atualizarListaMarketplaces();
        }

        // ===== C√ÅLCULO PRINCIPAL =====
        function calcular() {
            var custo = parseFloat(document.getElementById('custoProduto').value) || 0;
            var margem = parseFloat(document.getElementById('margemLucro').value) || 0;
            var tipoMargem = document.getElementById('tipoMargem').value;
            var empresaId = document.getElementById('empresaSelecionada').value;
            var marketplaceId = document.getElementById('marketplaceSelecionado').value;
            var descontoMarketplace = parseFloat(document.getElementById('descontoMarketplace').value) || 0;
            var coParticipacaoVendedor = parseFloat(document.getElementById('coParticipacaoVendedor').value) || 0;
            var freteParaImposto = parseFloat(document.getElementById('freteParaImposto').value) || 0;
            var freteParaComissao = parseFloat(document.getElementById('freteParaComissao').value) || 0;
            
            if (custo <= 0) {
                mostrarResultadoVazio();
                return;
            }
            
            var resultado = calcularPrecoIterativo({
                custo: custo,
                margem: margem,
                tipoMargem: tipoMargem,
                empresaId: empresaId,
                marketplaceId: marketplaceId,
                descontoMarketplace: descontoMarketplace,
                coParticipacaoVendedor: coParticipacaoVendedor,
                freteParaImposto: freteParaImposto,
                freteParaComissao: freteParaComissao
            });
            
            if (resultado) {
                mostrarResultado(resultado);
            } else {
                mostrarResultadoVazio();
            }
        }

        function calcularPrecoIterativo(config) {
            var maxIteracoes = 200;
            var tolerancia = 0.001;
            var precoEstimado = config.custo * 3;
            
            var precoMinimo = config.custo * 1.1;
            var precoMaximo = config.custo * 10;
            
            for (var i = 0; i < maxIteracoes; i++) {
                var resultadoTeste = calcularComPreco(precoEstimado, config);
                var margemReal = resultadoTeste.margemReal;
                var diferenca = Math.abs(margemReal - config.margem);
                
                if (diferenca <= tolerancia) {
                    return resultadoTeste;
                }
                
                if (margemReal < config.margem) {
                    precoMinimo = precoEstimado;
                    precoEstimado = (precoEstimado + precoMaximo) / 2;
                } else {
                    precoMaximo = precoEstimado;
                    precoEstimado = (precoMinimo + precoEstimado) / 2;
                }
                
                if (Math.abs(precoMaximo - precoMinimo) < 0.01) {
                    break;
                }
            }
            
            return calcularComPreco(precoEstimado, config);
        }

        function calcularComPreco(precoSemDesconto, config) {
            var gastosDetalhados = [];
            var gastosFixosTotal = 0;
            var gastosPercentuaisTotal = 0;
            
            var valorDescontoTotal = precoSemDesconto * (config.descontoMarketplace / 100);
            var valorDescontoVendedor = precoSemDesconto * (config.coParticipacaoVendedor / 100);
            var precoFinalComprador = precoSemDesconto - valorDescontoTotal;
            
            var precoParaCalculo = config.descontoMarketplace > 0 ? precoFinalComprador : precoSemDesconto;
            
            var impostoPercentual = 0;
            var comissaoPercentual = 0;
            
            if (config.empresaId) {
                var empresa = encontrarEmpresa(config.empresaId);
                if (empresa) {
                    impostoPercentual = empresa.impostoPercentual || 0;
                    
                    var impostoSobreProduto = (precoParaCalculo * impostoPercentual) / 100;
                    gastosPercentuaisTotal += impostoSobreProduto;
                    gastosDetalhados.push({
                        nome: 'Impostos sobre Produto (' + empresa.nome + ')',
                        valor: impostoPercentual,
                        valorCalculado: impostoSobreProduto,
                        categoria: 'empresa'
                    });
                    
                    empresa.custosFixos.forEach(custo => {
                        var valorCusto = parseFloat(custo.valor) || 0;
                        var valorCalculado = 0;
                        
                        if (custo.tipo === 'fixo') {
                            gastosFixosTotal += valorCusto;
                            valorCalculado = valorCusto;
                        } else {
                            var baseCalculo = precoParaCalculo + config.freteParaImposto;
                            valorCalculado = (baseCalculo * valorCusto) / 100;
                            gastosPercentuaisTotal += valorCalculado;
                        }
                        
                        gastosDetalhados.push({
                            nome: custo.nome + ' (' + empresa.nome + ')',
                            valor: valorCusto,
                            valorCalculado: valorCalculado,
                            categoria: 'empresa'
                        });
                    });
                }
            }
            
            if (config.marketplaceId) {
                var marketplace = encontrarMarketplace(config.marketplaceId);
                if (marketplace) {
                    comissaoPercentual = marketplace.comissaoPercentual || 0;
                    
                    var comissaoSobreProduto = (precoParaCalculo * comissaoPercentual) / 100;
                    gastosPercentuaisTotal += comissaoSobreProduto;
                    gastosDetalhados.push({
                        nome: 'Comiss√£o sobre Produto (' + marketplace.nome + ')',
                        valor: comissaoPercentual,
                        valorCalculado: comissaoSobreProduto,
                        categoria: 'marketplace'
                    });
                    
                    marketplace.custosFixos.forEach(custo => {
                        var valorCusto = parseFloat(custo.valor) || 0;
                        var valorCalculado = 0;
                        
                        if (custo.tipo === 'fixo') {
                            gastosFixosTotal += valorCusto;
                            valorCalculado = valorCusto;
                        } else {
                            var baseCalculo = precoParaCalculo + config.freteParaComissao;
                            valorCalculado = (baseCalculo * valorCusto) / 100;
                            gastosPercentuaisTotal += valorCalculado;
                        }
                        
                        gastosDetalhados.push({
                            nome: custo.nome + ' (' + marketplace.nome + ')',
                            valor: valorCusto,
                            valorCalculado: valorCalculado,
                            categoria: 'marketplace'
                        });
                    });
                }
            }
            
            if (config.freteParaImposto > 0 && impostoPercentual > 0) {
                var impostoFrete = (config.freteParaImposto * impostoPercentual) / 100;
                gastosPercentuaisTotal += impostoFrete;
                gastosDetalhados.push({
                    nome: 'Impostos sobre Frete',
                    valor: impostoPercentual,
                    valorCalculado: impostoFrete,
                    categoria: 'frete'
                });
            }
            
            if (config.freteParaComissao > 0 && comissaoPercentual > 0) {
                var comissaoFrete = (config.freteParaComissao * comissaoPercentual) / 100;
                gastosPercentuaisTotal += comissaoFrete;
                gastosDetalhados.push({
                    nome: 'Comiss√£o sobre Frete',
                    valor: comissaoPercentual,
                    valorCalculado: comissaoFrete,
                    categoria: 'frete'
                });
            }
            
            gastosAdicionais.forEach(gasto => {
                var valor = parseFloat(gasto.valor) || 0;
                var valorCalculado = 0;
                
                if (gasto.tipo === 'fixo') {
                    gastosFixosTotal += valor;
                    valorCalculado = valor;
                } else {
                    var baseCalculo = precoParaCalculo + config.freteParaImposto;
                    valorCalculado = (baseCalculo * valor) / 100;
                    gastosPercentuaisTotal += valorCalculado;
                }
                
                gastosDetalhados.push({
                    nome: gasto.nome + ' (Extra)',
                    valor: valor,
                    valorCalculado: valorCalculado,
                    categoria: 'adicional'
                });
            });
            
            var totalCustosOperacionais = gastosFixosTotal + gastosPercentuaisTotal;
            
            if (config.coParticipacaoVendedor > 0) {
                totalCustosOperacionais += valorDescontoVendedor;
                
                gastosDetalhados.push({
                    nome: 'Co-participa√ß√£o em Desconto',
                    valor: config.coParticipacaoVendedor,
                    valorCalculado: valorDescontoVendedor,
                    categoria: 'desconto'
                });
            }
            
            var lucroLiquido = precoFinalComprador - totalCustosOperacionais - config.custo;
            
            var margemReal;
            if (config.tipoMargem === 'venda') {
                margemReal = (lucroLiquido / precoFinalComprador) * 100;
            } else {
                margemReal = (lucroLiquido / config.custo) * 100;
            }
            
            return {
                precoVendaSemDesconto: precoSemDesconto,
                precoFinalComprador: precoFinalComprador,
                custoBase: config.custo,
                gastosFixosTotal: gastosFixosTotal,
                gastosPercentuaisTotal: gastosPercentuaisTotal,
                totalCustosOperacionais: totalCustosOperacionais,
                valorDescontoTotal: valorDescontoTotal,
                valorDescontoVendedor: valorDescontoVendedor,
                lucroLiquido: lucroLiquido,
                margemReal: margemReal,
                gastosDetalhados: gastosDetalhados,
                descontoMarketplace: config.descontoMarketplace,
                coParticipacaoVendedor: config.coParticipacaoVendedor,
                freteParaImposto: config.freteParaImposto,
                freteParaComissao: config.freteParaComissao,
                margemDesejada: config.margem,
                tipoMargem: config.tipoMargem
            };
        }

        function encontrarEmpresa(id) {
            return empresas.find(e => e.id == id);
        }

        function encontrarMarketplace(id) {
            return marketplaces.find(m => m.id == id);
        }

        function mostrarResultado(dados) {
            var temDesconto = dados.descontoMarketplace > 0;
            var corLucro = dados.lucroLiquido >= 0 ? 'bg-mint-green' : 'bg-red-600';
            
            var html = `
                <div class="space-y-6">
                    ${temDesconto ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-purple-900/30 border border-purple-500 rounded-lg text-center">
                            <p class="text-xs text-purple-300">Pre√ßo Original</p>
                            <p class="text-2xl font-bold text-white">R$ ${dados.precoVendaSemDesconto.toFixed(2)}</p>
                        </div>
                        <div class="p-4 bg-green-900/30 border border-green-500 rounded-lg text-center">
                            <p class="text-xs text-green-300">Pre√ßo Final Cliente</p>
                            <p class="text-2xl font-bold text-white">R$ ${dados.precoFinalComprador.toFixed(2)}</p>
                        </div>
                    </div>
                    ` : `
                    <div class="p-6 bg-gradient-to-r from-orange-600 to-purple-600 rounded-lg text-center shadow-xl">
                        <p class="text-sm text-white/80">Pre√ßo de Venda</p>
                        <p class="text-4xl font-bold text-white">R$ ${dados.precoVendaSemDesconto.toFixed(2)}</p>
                    </div>
                    `}
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 ${corLucro} rounded-lg text-center shadow-lg">
                            <p class="text-xs text-white">Lucro L√≠quido</p>
                            <p class="text-xl font-bold text-white">R$ ${dados.lucroLiquido.toFixed(2)}</p>
                        </div>
                        <div class="p-4 bg-cyan-500 rounded-lg text-center shadow-lg">
                            <p class="text-xs text-white">Margem %</p>
                            <p class="text-xl font-bold text-white">${dados.margemReal.toFixed(2)}%</p>
                        </div>
                        <div class="p-4 bg-orange-500 rounded-lg text-center shadow-lg">
                            <p class="text-xs text-white">Custos Totais</p>
                            <p class="text-xl font-bold text-white">R$ ${(dados.custoBase + dados.totalCustosOperacionais).toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Custo Base:</span>
                            <span class="text-white font-semibold">R$ ${dados.custoBase.toFixed(2)}</span>
                        </div>
                        ${dados.gastosDetalhados.map(g => `
                            <div class="flex justify-between">
                                <span class="text-gray-400">${g.nome}:</span>
                                <span class="text-white">R$ ${g.valorCalculado.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('resultado').innerHTML = html;
        }

        function mostrarResultadoVazio() {
            document.getElementById('resultado').innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üßÆ</div>
                    <p class="text-gray-400">Preencha os dados para ver o c√°lculo</p>
                </div>
            `;
        }

        // ===== GASTOS ADICIONAIS =====
        function adicionarGastoAdicional() {
            gastosAdicionais.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarGastosAdicionais();
        }

        function atualizarGastosAdicionais() {
            var container = document.getElementById('gastosAdicionais');
            container.innerHTML = '';
            
            gastosAdicionais.forEach((gasto, i) => {
                container.innerHTML += `
                    <div class="flex gap-2 mb-2">
                        <input type="text" value="${gasto.nome}" onchange="gastosAdicionais[${i}].nome = this.value; calcular();" 
                               placeholder="Nome" class="input-neobrutal flex-1 text-sm">
                        <input type="number" step="0.01" value="${gasto.valor}" onchange="gastosAdicionais[${i}].valor = this.value; calcular();" 
                               placeholder="Valor" class="input-neobrutal w-20 text-sm">
                        <select onchange="gastosAdicionais[${i}].tipo = this.value; calcular();" class="input-neobrutal w-16 text-sm">
                            <option value="fixo"${gasto.tipo === 'fixo' ? ' selected' : ''}>R$</option>
                            <option value="porcentagem"${gasto.tipo === 'porcentagem' ? ' selected' : ''}>%</option>
                        </select>
                        <button onclick="removerGastoAdicional(${i})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        function removerGastoAdicional(index) {
            gastosAdicionais.splice(index, 1);
            atualizarGastosAdicionais();
            calcular();
        }

        // ===== EMPRESAS =====
        function adicionarCustoEmpresa() {
            custosNovaEmpresa.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarCustosNovaEmpresa();
        }

        function atualizarCustosNovaEmpresa() {
            var container = document.getElementById('custosNovaEmpresa');
            container.innerHTML = '';
            
            custosNovaEmpresa.forEach((custo, i) => {
                container.innerHTML += `
                    <div class="flex gap-2">
                        <input type="text" value="${custo.nome}" onchange="custosNovaEmpresa[${i}].nome = this.value;" 
                               placeholder="Nome" class="input-neobrutal flex-1 text-sm">
                        <input type="number" step="0.01" value="${custo.valor}" onchange="custosNovaEmpresa[${i}].valor = this.value;" 
                               placeholder="Valor" class="input-neobrutal w-20 text-sm">
                        <select onchange="custosNovaEmpresa[${i}].tipo = this.value;" class="input-neobrutal w-16 text-sm">
                            <option value="fixo"${custo.tipo === 'fixo' ? ' selected' : ''}>R$</option>
                            <option value="porcentagem"${custo.tipo === 'porcentagem' ? ' selected' : ''}>%</option>
                        </select>
                        <button onclick="removerCustoEmpresa(${i})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        function removerCustoEmpresa(index) {
            custosNovaEmpresa.splice(index, 1);
            atualizarCustosNovaEmpresa();
        }

        function salvarEmpresa() {
            var nome = document.getElementById('nomeNovaEmpresa').value.trim();
            var impostoPercentual = parseFloat(document.getElementById('impostoEmpresa').value);
            
            if (!nome) {
                alert('Por favor, digite o nome da empresa!');
                return;
            }
            
            if (isNaN(impostoPercentual) || impostoPercentual < 0) {
                alert('Por favor, informe o percentual de imposto!');
                return;
            }
            
            var novaEmpresa = {
                id: Date.now(),
                nome: nome,
                impostoPercentual: impostoPercentual,
                custosFixos: custosNovaEmpresa.slice()
            };
            
            empresas.push(novaEmpresa);
            salvarDados();
            
            document.getElementById('nomeNovaEmpresa').value = '';
            document.getElementById('impostoEmpresa').value = '';
            custosNovaEmpresa = [];
            atualizarCustosNovaEmpresa();
            atualizarListas();
            
            alert('Empresa salva com sucesso!');
        }

        function atualizarListaEmpresas() {
            var container = document.getElementById('listaEmpresas');
            container.innerHTML = '';
            
            empresas.forEach(empresa => {
                var custosTexto = `Imposto: ${(empresa.impostoPercentual || 0).toFixed(1)}%`;
                empresa.custosFixos.forEach(custo => {
                    custosTexto += `, ${custo.nome}: `;
                    if (custo.tipo === 'fixo') custosTexto += 'R$ ';
                    custosTexto += custo.valor;
                    if (custo.tipo === 'porcentagem') custosTexto += '%';
                });
                
                container.innerHTML += `
                    <div class="p-3 bg-gray-800 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-white">${empresa.nome}</div>
                            <div class="text-xs text-gray-400">${custosTexto}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarEmpresa(${empresa.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs text-white">‚úèÔ∏è</button>
                            <button onclick="deletarEmpresa(${empresa.id})" class="px-3 py-1 rounded text-xs text-white" style="background: linear-gradient(135deg, #ff7e5f 0%, #764ba2 100%); box-shadow: 0 4px 10px rgba(255, 126, 95, 0.4);">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }

        function editarEmpresa(id) {
            var empresa = encontrarEmpresa(id);
            if (!empresa) return;
            
            document.getElementById('nomeNovaEmpresa').value = empresa.nome;
            document.getElementById('impostoEmpresa').value = empresa.impostoPercentual || 0;
            custosNovaEmpresa = empresa.custosFixos.slice();
            atualizarCustosNovaEmpresa();
            
            empresas = empresas.filter(e => e.id !== id);
            salvarDados();
            atualizarListas();
        }

        function deletarEmpresa(id) {
            var empresa = encontrarEmpresa(id);
            if (!empresa) return;
            
            if (confirm(`Deletar empresa "${empresa.nome}"?`)) {
                empresas = empresas.filter(e => e.id !== id);
                salvarDados();
                atualizarListas();
            }
        }

        // ===== MARKETPLACES =====
        function adicionarCustoMarketplace() {
            custosNovoMarketplace.push({ nome: '', valor: 0, tipo: 'fixo' });
            atualizarCustosNovoMarketplace();
        }

        function atualizarCustosNovoMarketplace() {
            var container = document.getElementById('custosNovoMarketplace');
            container.innerHTML = '';
            
            custosNovoMarketplace.forEach((custo, i) => {
                container.innerHTML += `
                    <div class="flex gap-2">
                        <input type="text" value="${custo.nome}" onchange="custosNovoMarketplace[${i}].nome = this.value;" 
                               placeholder="Nome" class="input-neobrutal flex-1 text-sm">
                        <input type="number" step="0.01" value="${custo.valor}" onchange="custosNovoMarketplace[${i}].valor = this.value;" 
                               placeholder="Valor" class="input-neobrutal w-20 text-sm">
                        <select onchange="custosNovoMarketplace[${i}].tipo = this.value;" class="input-neobrutal w-16 text-sm">
                            <option value="fixo"${custo.tipo === 'fixo' ? ' selected' : ''}>R$</option>
                            <option value="porcentagem"${custo.tipo === 'porcentagem' ? ' selected' : ''}>%</option>
                        </select>
                        <button onclick="removerCustoMarketplace(${i})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        function removerCustoMarketplace(index) {
            custosNovoMarketplace.splice(index, 1);
            atualizarCustosNovoMarketplace();
        }

        function salvarMarketplace() {
            var nome = document.getElementById('nomeNovoMarketplace').value.trim();
            var comissaoPercentual = parseFloat(document.getElementById('comissaoMarketplace').value);
            
            if (!nome) {
                alert('Por favor, digite o nome do marketplace!');
                return;
            }
            
            if (isNaN(comissaoPercentual) || comissaoPercentual < 0) {
                alert('Por favor, informe o percentual de comiss√£o!');
                return;
            }
            
            var novoMarketplace = {
                id: Date.now(),
                nome: nome,
                comissaoPercentual: comissaoPercentual,
                custosFixos: custosNovoMarketplace.slice()
            };
            
            marketplaces.push(novoMarketplace);
            salvarDados();
            
            document.getElementById('nomeNovoMarketplace').value = '';
            document.getElementById('comissaoMarketplace').value = '';
            custosNovoMarketplace = [];
            atualizarCustosNovoMarketplace();
            atualizarListas();
            
            alert('Marketplace salvo com sucesso!');
        }

        function atualizarListaMarketplaces() {
            var container = document.getElementById('listaMarketplaces');
            container.innerHTML = '';
            
            marketplaces.forEach(marketplace => {
                var custosTexto = `Comiss√£o: ${(marketplace.comissaoPercentual || 0).toFixed(1)}%`;
                marketplace.custosFixos.forEach(custo => {
                    custosTexto += `, ${custo.nome}: `;
                    if (custo.tipo === 'fixo') custosTexto += 'R$ ';
                    custosTexto += custo.valor;
                    if (custo.tipo === 'porcentagem') custosTexto += '%';
                });
                
                container.innerHTML += `
                    <div class="p-3 bg-gray-800 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-white">${marketplace.nome}</div>
                            <div class="text-xs text-gray-400">${custosTexto}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarMarketplace(${marketplace.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs text-white">‚úèÔ∏è</button>
                            <button onclick="deletarMarketplace(${marketplace.id})" class="px-3 py-1 rounded text-xs text-white" style="background: linear-gradient(135deg, #ff7e5f 0%, #764ba2 100%); box-shadow: 0 4px 10px rgba(255, 126, 95, 0.4);">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }

        function editarMarketplace(id) {
            var marketplace = encontrarMarketplace(id);
            if (!marketplace) return;
            
            document.getElementById('nomeNovoMarketplace').value = marketplace.nome;
            document.getElementById('comissaoMarketplace').value = marketplace.comissaoPercentual || 0;
            custosNovoMarketplace = marketplace.custosFixos.slice();
            atualizarCustosNovoMarketplace();
            
            marketplaces = marketplaces.filter(m => m.id !== id);
            salvarDados();
            atualizarListas();
        }

        function deletarMarketplace(id) {
            var marketplace = encontrarMarketplace(id);
            if (!marketplace) return;
            
            if (confirm(`Deletar marketplace "${marketplace.nome}"?`)) {
                marketplaces = marketplaces.filter(m => m.id !== id);
                salvarDados();
                atualizarListas();
            }
        }

        // ===== BACKUP/RESTAURA√á√ÉO =====
        function exportarConfiguracoes() {
            var dados = {
                empresas: empresas,
                marketplaces: marketplaces,
                dataExport: new Date().toLocaleString('pt-BR')
            };
            
            var arquivo = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(arquivo);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'sisPre_backup_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importarConfiguracoes(event) {
            var arquivo = event.target.files[0];
            if (!arquivo) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados = JSON.parse(e.target.result);
                    if (dados.empresas && dados.marketplaces) {
                        empresas = dados.empresas;
                        marketplaces = dados.marketplaces;
                        salvarDados();
                        atualizarListas();
                        alert('Configura√ß√µes importadas com sucesso!');
                    } else {
                        alert('Arquivo inv√°lido!');
                    }
                } catch (error) {
                    alert('Erro ao importar arquivo!');
                }
            };
            reader.readAsText(arquivo);
            event.target.value = '';
        }

        function limparTodosDados() {
            if (confirm('Apagar todas as configura√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('sisPre_empresas');
                localStorage.removeItem('sisPre_marketplaces');
                empresas = [];
                marketplaces = [];
                gastosAdicionais = [];
                custosNovaEmpresa = [];
                custosNovoMarketplace = [];
                
                document.getElementById('nomeNovaEmpresa').value = '';
                document.getElementById('impostoEmpresa').value = '';
                document.getElementById('nomeNovoMarketplace').value = '';
                document.getElementById('comissaoMarketplace').value = '';
                
                atualizarListas();
                atualizarGastosAdicionais();
                atualizarCustosNovaEmpresa();
                atualizarCustosNovoMarketplace();
                mostrarResultadoVazio();
                
                alert('Todas as configura√ß√µes foram apagadas!');
            }
        }

        // ===== LOTE =====
        function baixarModeloLote() {
            var csv = 'Nome do Produto,Custo,Empresa ID,Marketplace ID,Margem Lucro %\n';
            csv += 'Produto Exemplo,50.00,1,1,30\n';
            csv += 'Outro Produto,75.50,1,2,25\n';
            
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'modelo_lote_sispre.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function processarPlanilhaLote(event) {
            var arquivo = event.target.files[0];
            if (!arquivo) return;
            
            var nomeArquivo = arquivo.name.toLowerCase();
            
            if (nomeArquivo.endsWith('.csv')) {
                Papa.parse(arquivo, {
                    header: true,
                    complete: function(results) {
                        processarDadosLote(results.data);
                    },
                    error: function(error) {
                        alert('Erro ao ler CSV: ' + error.message);
                    }
                });
            } else if (nomeArquivo.endsWith('.xlsx') || nomeArquivo.endsWith('.xls')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = new Uint8Array(e.target.result);
                        var workbook = XLSX.read(data, { type: 'array' });
                        var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        var jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        processarDadosLote(jsonData);
                    } catch (error) {
                        alert('Erro ao ler Excel: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(arquivo);
            }
            
            event.target.value = '';
        }

        function processarDadosLote(dados) {
            if (!dados || dados.length === 0) {
                alert('Nenhum dado encontrado na planilha!');
                return;
            }
            
            var resultados = [];
            
            dados.forEach((linha, index) => {
                if (!linha['Nome do Produto'] || !linha['Custo']) return;
                
                var custo = parseFloat(linha['Custo']) || 0;
                var margem = parseFloat(linha['Margem Lucro %']) || 0;
                var empresaId = linha['Empresa ID'];
                var marketplaceId = linha['Marketplace ID'];
                
                var resultado = calcularPrecoIterativo({
                    custo: custo,
                    margem: margem,
                    tipoMargem: 'venda',
                    empresaId: empresaId,
                    marketplaceId: marketplaceId,
                    descontoMarketplace: 0,
                    coParticipacaoVendedor: 0,
                    freteParaImposto: 0,
                    freteParaComissao: 0
                });
                
                if (resultado) {
                    resultados.push({
                        nome: linha['Nome do Produto'],
                        custo: custo,
                        precoSugerido: resultado.precoVendaSemDesconto,
                        lucro: resultado.lucroLiquido,
                        margem: resultado.margemReal
                    });
                }
            });
            
            exibirResultadosLote(resultados);
        }

        function exibirResultadosLote(resultados) {
            var container = document.getElementById('tabelaResultadosLote');
            
            var html = `
                <table class="w-full text-sm">
                    <thead class="bg-cyan-900/50">
                        <tr>
                            <th class="p-3 text-left text-cyan-400">Produto</th>
                            <th class="p-3 text-right text-cyan-400">Custo</th>
                            <th class="p-3 text-right text-cyan-400">Pre√ßo Sugerido</th>
                            <th class="p-3 text-right text-cyan-400">Lucro</th>
                            <th class="p-3 text-right text-cyan-400">Margem %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            resultados.forEach((r, i) => {
                var corLucro = r.lucro >= 0 ? 'text-green-400' : 'text-red-400';
                var bgRow = i % 2 === 0 ? 'bg-gray-800/30' : 'bg-gray-800/10';
                
                html += `
                    <tr class="${bgRow}">
                        <td class="p-3 text-white">${r.nome}</td>
                        <td class="p-3 text-right text-gray-300">R$ ${r.custo.toFixed(2)}</td>
                        <td class="p-3 text-right text-orange-400 font-semibold">R$ ${r.precoSugerido.toFixed(2)}</td>
                        <td class="p-3 text-right ${corLucro} font-semibold">R$ ${r.lucro.toFixed(2)}</td>
                        <td class="p-3 text-right ${corLucro}">${r.margem.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            document.getElementById('resultadoLote').classList.remove('hidden');
            window.resultadosLoteGlobal = resultados;
        }

        function exportarResultadosLote() {
            if (!window.resultadosLoteGlobal || window.resultadosLoteGlobal.length === 0) {
                alert('Nenhum resultado para exportar!');
                return;
            }
            
            var csv = 'Nome do Produto,Custo,Pre√ßo Sugerido,Lucro,Margem %\n';
            
            window.resultadosLoteGlobal.forEach(r => {
                csv += `"${r.nome}",${r.custo.toFixed(2)},${r.precoSugerido.toFixed(2)},${r.lucro.toFixed(2)},${r.margem.toFixed(2)}\n`;
            });
            
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'resultados_lote_sispre.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===== AN√ÅLISE REVERSA =====
        function calcularAnalise() {
            var precoVenda = parseFloat(document.getElementById('precoAnalise').value) || 0;
            var custo = parseFloat(document.getElementById('custoAnalise').value) || 0;
            var empresaId = document.getElementById('empresaAnalise').value;
            var marketplaceId = document.getElementById('marketplaceAnalise').value;
            var descontoMp = parseFloat(document.getElementById('descontoAnalise').value) || 0;
            var coparticipacao = parseFloat(document.getElementById('coparticipacaoAnalise').value) || 0;
            
            if (precoVenda <= 0 || custo <= 0) {
                document.getElementById('resultadoAnalise').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìä</div>
                        <p class="text-gray-400">Preencha os dados para ver a an√°lise</p>
                    </div>
                `;
                return;
            }
            
            var empresa = encontrarEmpresa(empresaId);
            var marketplace = encontrarMarketplace(marketplaceId);
            
            if (!empresa || !marketplace) {
                alert('Selecione uma empresa e um marketplace!');
                return;
            }
            
            var valorDescontoTotal = precoVenda * (descontoMp / 100);
            var valorCoparticipacao = precoVenda * (coparticipacao / 100);
            var precoFinalCliente = precoVenda - valorDescontoTotal;
            
            var impostoPercentual = empresa.impostoPercentual || 0;
            var comissaoPercentual = marketplace.comissaoPercentual || 0;
            
            var valorImposto = (precoFinalCliente * impostoPercentual) / 100;
            var valorComissao = (precoFinalCliente * comissaoPercentual) / 100;
            
            var custosFixosEmpresa = 0;
            empresa.custosFixos.forEach(c => {
                if (c.tipo === 'fixo') {
                    custosFixosEmpresa += parseFloat(c.valor) || 0;
                } else {
                    custosFixosEmpresa += (precoFinalCliente * parseFloat(c.valor)) / 100;
                }
            });
            
            var custosFixosMarketplace = 0;
            marketplace.custosFixos.forEach(c => {
                if (c.tipo === 'fixo') {
                    custosFixosMarketplace += parseFloat(c.valor) || 0;
                } else {
                    custosFixosMarketplace += (precoFinalCliente * parseFloat(c.valor)) / 100;
                }
            });
            
            var totalCustos = custo + valorImposto + valorComissao + custosFixosEmpresa + custosFixosMarketplace + valorCoparticipacao;
            var lucroLiquido = precoFinalCliente - totalCustos;
            var margemPercentual = (lucroLiquido / precoFinalCliente) * 100;
            
            var corLucro = lucroLiquido >= 0 ? 'bg-mint-green' : 'bg-red-600';
            var corMargem = margemPercentual >= 20 ? 'bg-green-500' : margemPercentual >= 10 ? 'bg-yellow-500' : 'bg-red-500';
            
            var html = `
                <div class="space-y-6">
                    ${descontoMp > 0 ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-purple-900/30 border border-purple-500 rounded-lg text-center">
                            <p class="text-xs text-purple-300">Pre√ßo Original</p>
                            <p class="text-2xl font-bold text-white">R$ ${precoVenda.toFixed(2)}</p>
                        </div>
                        <div class="p-4 bg-green-900/30 border border-green-500 rounded-lg text-center">
                            <p class="text-xs text-green-300">Pre√ßo Cliente</p>
                            <p class="text-2xl font-bold text-white">R$ ${precoFinalCliente.toFixed(2)}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 ${corLucro} rounded-lg text-center shadow-lg">
                            <p class="text-xs text-gray-900">Lucro L√≠quido</p>
                            <p class="text-2xl font-bold text-gray-900">R$ ${lucroLiquido.toFixed(2)}</p>
                        </div>
                        <div class="p-4 ${corMargem} rounded-lg text-center shadow-lg">
                            <p class="text-xs text-gray-900">Margem</p>
                            <p class="text-2xl font-bold text-gray-900">${margemPercentual.toFixed(2)}%</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Custo do Produto:</span>
                            <span class="text-white font-semibold">R$ ${custo.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Impostos (${impostoPercentual.toFixed(1)}%):</span>
                            <span class="text-white">R$ ${valorImposto.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Comiss√£o (${comissaoPercentual.toFixed(1)}%):</span>
                            <span class="text-white">R$ ${valorComissao.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Custos Empresa:</span>
                            <span class="text-white">R$ ${custosFixosEmpresa.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Custos Marketplace:</span>
                            <span class="text-white">R$ ${custosFixosMarketplace.toFixed(2)}</span>
                        </div>
                        ${coparticipacao > 0 ? `
                        <div class="flex justify-between">
                            <span class="text-gray-400">Co-participa√ß√£o (${coparticipacao.toFixed(1)}%):</span>
                            <span class="text-white">R$ ${valorCoparticipacao.toFixed(2)}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between border-t border-gray-700 pt-2 font-bold">
                            <span class="text-orange-400">Total de Custos:</span>
                            <span class="text-orange-400">R$ ${totalCustos.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="p-4 ${lucroLiquido >= 0 ? 'bg-green-900/20 border-green-600' : 'bg-red-900/20 border-red-600'} border rounded-lg">
                        <p class="text-sm ${lucroLiquido >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${lucroLiquido >= 0 
                                ? '‚úÖ Cen√°rio vi√°vel! Voc√™ ter√° lucro nesta opera√ß√£o.' 
                                : '‚ö†Ô∏è Aten√ß√£o! Este cen√°rio resultar√° em preju√≠zo.'}
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('resultadoAnalise').innerHTML = html;
        }

        // Atualizar dropdowns de an√°lise quando abrir a tela
        function atualizarDropdownsAnalise() {
            var selectEmpresa = document.getElementById('empresaAnalise');
            var selectMarketplace = document.getElementById('marketplaceAnalise');
            
            if (selectEmpresa && selectMarketplace) {
                selectEmpresa.innerHTML = '<option value="">Selecione...</option>';
                selectMarketplace.innerHTML = '<option value="">Selecione...</option>';
                
                empresas.forEach(empresa => {
                    selectEmpresa.innerHTML += `<option value="${empresa.id}">${empresa.nome}</option>`;
                });
                
                marketplaces.forEach(marketplace => {
                    selectMarketplace.innerHTML += `<option value="${marketplace.id}">${marketplace.nome}</option>`;
                });
            }
        }
    </script>
</body>
</html>
